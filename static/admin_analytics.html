<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Session Analytics</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card .value {
      font-size: 26px;
      font-weight: 600;
      color: #1976d2;
    }

    .card .value.success {
      color: #2e7d32;
    }

    .card .value.warning {
      color: #d32f2f;
    }

    .card .subtext {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .section {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 16px;
      margin: 0 0 12px 0;
    }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select, button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      cursor: pointer;
      background: #fafafa;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
    }

    button:disabled {
      background: #ccc;
      cursor: default;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #f9f9f9;
      font-weight: 600;
    }

    tr:hover {
      background: #f5f9ff;
    }

    .status-pill {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
    }

    .status-completed {
      background: #dcfce7;
      color: #166534;
    }

    .status-abandoned {
      background: #fee2e2;
      color: #991b1b;
    }

    .reason-pill {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
    }

    .reason-browser_close {
      background: #fee2e2;
      color: #991b1b;
    }

    .reason-refresh {
      background: #fef3c7;
      color: #92400e;
    }

    .reason-navigation {
      background: #dbeafe;
      color: #1e40af;
    }

    .had-items {
      color: #d32f2f;
      font-weight: 600;
    }

    .no-items {
      color: #666;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      font-size: 13px;
    }

    .trend-bar {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 80px;
      margin-top: 8px;
    }

    .trend-day {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .trend-stack {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .trend-bar-completed {
      width: 100%;
      background: #4caf50;
      border-radius: 2px 2px 0 0;
    }

    .trend-bar-abandoned {
      width: 100%;
      background: #f44336;
    }

    .trend-label {
      font-size: 10px;
      color: #666;
    }

    .trend-count {
      font-size: 10px;
      font-weight: 600;
    }

    .message-preview {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 12px;
      color: #666;
    }

    .muted {
      color: #666;
    }

    .nav-links {
      margin-bottom: 16px;
      font-size: 13px;
    }

    .nav-links a {
      color: #1976d2;
      text-decoration: none;
      margin-right: 16px;
    }

    .nav-links a:hover {
      text-decoration: underline;
    }

    .reason-breakdown {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .reason-stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .legend-dot.completed {
      background: #4caf50;
    }

    .legend-dot.abandoned {
      background: #f44336;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 16px 20px;
      overflow-y: auto;
      flex: 1;
    }

    .session-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #eee;
    }

    .info-item {
      font-size: 13px;
    }

    .info-item label {
      color: #666;
      display: block;
      margin-bottom: 2px;
    }

    .info-item .val {
      font-weight: 500;
    }

    .conversation {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .conv-msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
    }

    .conv-msg.user {
      align-self: flex-end;
      background: #1976d2;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .conv-msg.assistant {
      align-self: flex-start;
      background: #f0f0f0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .conv-empty {
      color: #888;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    tr.clickable {
      cursor: pointer;
    }

    tr.clickable:hover {
      background: #e3f2fd !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-links">
      <a href="/static/index.html">Customer Chat</a>
      <a href="/static/admin_menu.html">Menu</a>
      <a href="/static/admin_ingredients.html">Ingredients (86)</a>
      <a href="/static/admin_orders.html">Orders</a>
      <a href="/static/admin_analytics.html"><strong>Analytics</strong></a>
    </div>

    <h1>Session Analytics</h1>

    <div class="summary-cards">
      <div class="card">
        <h3>Total Sessions</h3>
        <div class="value" id="totalSessions">-</div>
        <div class="subtext">All time</div>
      </div>
      <div class="card">
        <h3>Completed</h3>
        <div class="value success" id="completedSessions">-</div>
        <div class="subtext" id="completionRate">-</div>
      </div>
      <div class="card">
        <h3>Abandoned</h3>
        <div class="value warning" id="abandonedSessions">-</div>
        <div class="subtext" id="abandonedWithItems">-</div>
      </div>
      <div class="card">
        <h3>Revenue</h3>
        <div class="value success" id="totalRevenue">-</div>
        <div class="subtext">From completed orders</div>
      </div>
      <div class="card">
        <h3>Lost Revenue</h3>
        <div class="value warning" id="lostRevenue">-</div>
        <div class="subtext">Abandoned with items</div>
      </div>
      <div class="card">
        <h3>Avg Duration</h3>
        <div class="value" id="avgDuration">-</div>
        <div class="subtext">Per session</div>
      </div>
    </div>

    <div class="section">
      <h2>Last 7 Days</h2>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot completed"></div> Completed</div>
        <div class="legend-item"><div class="legend-dot abandoned"></div> Abandoned</div>
      </div>
      <div class="trend-bar" id="trendChart"></div>
    </div>

    <div class="section">
      <h2>Abandonment by Reason</h2>
      <div class="reason-breakdown" id="reasonBreakdown"></div>
    </div>

    <div class="section">
      <h2>Sessions</h2>

      <div class="filters">
        <label>Status:</label>
        <select id="statusFilter">
          <option value="">All</option>
          <option value="completed">Completed</option>
          <option value="abandoned">Abandoned</option>
        </select>

        <label>Reason:</label>
        <select id="reasonFilter">
          <option value="">All</option>
          <option value="browser_close">Browser Close</option>
          <option value="refresh">Refresh</option>
          <option value="navigation">Navigation</option>
        </select>

        <label>Had Items:</label>
        <select id="itemsFilter">
          <option value="">All</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>

      <p class="muted" style="font-size: 12px; margin-bottom: 8px;">Click on a row to view the full conversation</p>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Status</th>
            <th>Reason</th>
            <th>Customer</th>
            <th>Messages</th>
            <th>Items</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>

      <div class="pagination">
        <div>
          <button id="prevPage">Prev</button>
          <button id="nextPage">Next</button>
        </div>
        <div id="pageInfo" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- Conversation Modal -->
  <div class="modal-overlay" id="conversationModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Session Conversation</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="session-info" id="modalSessionInfo"></div>
        <div class="conversation" id="modalConversation"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    let currentPage = 1;
    let currentStatus = "";
    let currentReason = "";
    let currentHadItems = "";
    let sessionsData = [];  // Store sessions for modal access

    const totalSessionsEl = document.getElementById("totalSessions");
    const completedSessionsEl = document.getElementById("completedSessions");
    const abandonedSessionsEl = document.getElementById("abandonedSessions");
    const completionRateEl = document.getElementById("completionRate");
    const abandonedWithItemsEl = document.getElementById("abandonedWithItems");
    const totalRevenueEl = document.getElementById("totalRevenue");
    const lostRevenueEl = document.getElementById("lostRevenue");
    const avgDurationEl = document.getElementById("avgDuration");
    const trendChartEl = document.getElementById("trendChart");
    const reasonBreakdownEl = document.getElementById("reasonBreakdown");
    const sessionsBodyEl = document.getElementById("sessionsBody");
    const statusFilterEl = document.getElementById("statusFilter");
    const reasonFilterEl = document.getElementById("reasonFilter");
    const itemsFilterEl = document.getElementById("itemsFilter");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfoEl = document.getElementById("pageInfo");
    const modalEl = document.getElementById("conversationModal");
    const modalSessionInfoEl = document.getElementById("modalSessionInfo");
    const modalConversationEl = document.getElementById("modalConversation");

    statusFilterEl.addEventListener("change", () => {
      currentStatus = statusFilterEl.value;
      currentPage = 1;
      fetchSessions();
    });

    reasonFilterEl.addEventListener("change", () => {
      currentReason = reasonFilterEl.value;
      currentPage = 1;
      fetchSessions();
    });

    itemsFilterEl.addEventListener("change", () => {
      currentHadItems = itemsFilterEl.value;
      currentPage = 1;
      fetchSessions();
    });

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        fetchSessions();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (!nextPageBtn.disabled) {
        currentPage++;
        fetchSessions();
      }
    });

    async function fetchSummary() {
      try {
        const resp = await fetch(`${API_BASE}/admin/analytics/summary`);
        if (!resp.ok) throw new Error("Failed to load summary");
        const data = await resp.json();

        totalSessionsEl.textContent = data.total_sessions;
        completedSessionsEl.textContent = data.completed_sessions;
        abandonedSessionsEl.textContent = data.abandoned_sessions;
        completionRateEl.textContent = `${data.completion_rate}% completion rate`;
        abandonedWithItemsEl.textContent = `${data.abandoned_with_items} with items`;
        totalRevenueEl.textContent = `$${data.total_revenue.toFixed(2)}`;
        lostRevenueEl.textContent = `$${data.total_lost_revenue.toFixed(2)}`;

        if (data.avg_session_duration) {
          const mins = Math.floor(data.avg_session_duration / 60);
          const secs = Math.round(data.avg_session_duration % 60);
          avgDurationEl.textContent = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        } else {
          avgDurationEl.textContent = "-";
        }

        // Render trend chart
        renderTrendChart(data.recent_trend);

        // Render reason breakdown
        renderReasonBreakdown(data.abandonment_by_reason);

      } catch (err) {
        console.error(err);
      }
    }

    function renderTrendChart(trend) {
      const maxTotal = Math.max(...trend.map(d => d.total), 1);

      trendChartEl.innerHTML = trend.map(d => {
        const completedHeight = Math.max((d.completed / maxTotal) * 60, d.completed > 0 ? 2 : 0);
        const abandonedHeight = Math.max((d.abandoned / maxTotal) * 60, d.abandoned > 0 ? 2 : 0);
        const dayName = new Date(d.date + "T12:00:00").toLocaleDateString("en-US", { weekday: "short" });
        return `
          <div class="trend-day">
            <div class="trend-count">${d.total}</div>
            <div class="trend-stack">
              <div class="trend-bar-completed" style="height: ${completedHeight}px;" title="Completed: ${d.completed}"></div>
              <div class="trend-bar-abandoned" style="height: ${abandonedHeight}px;" title="Abandoned: ${d.abandoned}"></div>
            </div>
            <div class="trend-label">${dayName}</div>
          </div>
        `;
      }).join("");
    }

    function renderReasonBreakdown(reasons) {
      const labels = {
        browser_close: "Browser Close",
        refresh: "Refresh",
        navigation: "Navigation"
      };

      if (Object.keys(reasons).length === 0) {
        reasonBreakdownEl.innerHTML = '<span class="muted">No abandoned sessions yet</span>';
        return;
      }

      reasonBreakdownEl.innerHTML = Object.entries(reasons).map(([reason, count]) => `
        <div class="reason-stat">
          <span class="reason-pill reason-${reason}">${labels[reason] || reason}</span>
          <span>${count}</span>
        </div>
      `).join("");
    }

    async function fetchSessions() {
      try {
        const params = new URLSearchParams();
        params.append("page", String(currentPage));
        params.append("page_size", "20");
        if (currentStatus) params.append("status", currentStatus);
        if (currentReason) params.append("reason", currentReason);
        if (currentHadItems) params.append("had_items", currentHadItems);

        const resp = await fetch(`${API_BASE}/admin/analytics/sessions?${params.toString()}`);
        if (!resp.ok) throw new Error("Failed to load sessions");
        const data = await resp.json();
        sessionsData = data.items;  // Store for modal access

        renderSessionsTable(data.items);
        pageInfoEl.textContent = `Page ${data.page} of ${Math.ceil(data.total / data.page_size) || 1} (${data.total} total)`;
        prevPageBtn.disabled = data.page <= 1;
        nextPageBtn.disabled = !data.has_next;

      } catch (err) {
        console.error(err);
        sessionsBodyEl.innerHTML = `<tr><td colspan="8" style="color:red;">Error loading data</td></tr>`;
      }
    }

    function renderSessionsTable(sessions) {
      if (!sessions.length) {
        sessionsBodyEl.innerHTML = `<tr><td colspan="7" class="muted">No sessions found</td></tr>`;
        return;
      }

      sessionsBodyEl.innerHTML = sessions.map((s, index) => {
        const time = new Date(s.ended_at).toLocaleString();

        const statusClass = s.status === "completed" ? "status-completed" : "status-abandoned";
        const statusLabel = s.status === "completed" ? "Completed" : "Abandoned";

        const reasonLabels = {
          browser_close: "Browser Close",
          refresh: "Refresh",
          navigation: "Navigation"
        };
        const reasonHtml = s.reason
          ? `<span class="reason-pill reason-${s.reason}">${reasonLabels[s.reason] || s.reason}</span>`
          : "-";

        const customerInfo = s.customer_name
          ? `${s.customer_name}${s.customer_phone ? ' (' + s.customer_phone + ')' : ''}`
          : "-";

        const itemsClass = s.had_items_in_cart ? "had-items" : "no-items";
        const itemsText = s.had_items_in_cart ? `${s.item_count} items` : "None";

        return `
          <tr class="clickable" onclick="openSessionModal(${index})">
            <td>${time}</td>
            <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
            <td>${reasonHtml}</td>
            <td>${customerInfo}</td>
            <td>${s.message_count}</td>
            <td class="${itemsClass}">${itemsText}</td>
            <td>${s.cart_total > 0 ? `$${s.cart_total.toFixed(2)}` : "-"}</td>
          </tr>
        `;
      }).join("");
    }

    function openSessionModal(index) {
      const session = sessionsData[index];
      if (!session) return;

      // Render session info
      const time = new Date(session.ended_at).toLocaleString();
      const statusLabel = session.status === "completed" ? "Completed" : "Abandoned";
      const reasonLabels = {
        browser_close: "Browser Close",
        refresh: "Refresh",
        navigation: "Navigation"
      };
      const reason = session.reason ? (reasonLabels[session.reason] || session.reason) : "-";
      const duration = session.session_duration_seconds
        ? `${Math.floor(session.session_duration_seconds / 60)}m ${session.session_duration_seconds % 60}s`
        : "-";

      modalSessionInfoEl.innerHTML = `
        <div class="info-item">
          <label>Time</label>
          <span class="val">${time}</span>
        </div>
        <div class="info-item">
          <label>Status</label>
          <span class="val">${statusLabel}</span>
        </div>
        <div class="info-item">
          <label>Reason</label>
          <span class="val">${reason}</span>
        </div>
        <div class="info-item">
          <label>Duration</label>
          <span class="val">${duration}</span>
        </div>
        <div class="info-item">
          <label>Messages</label>
          <span class="val">${session.message_count}</span>
        </div>
        <div class="info-item">
          <label>Cart Value</label>
          <span class="val">${session.cart_total > 0 ? `$${session.cart_total.toFixed(2)}` : "-"}</span>
        </div>
        ${session.customer_name ? `
          <div class="info-item">
            <label>Customer</label>
            <span class="val">${session.customer_name}${session.customer_phone ? ' (' + session.customer_phone + ')' : ''}</span>
          </div>
        ` : ''}
      `;

      // Render conversation
      const conversation = session.conversation_history || [];
      if (conversation.length === 0) {
        modalConversationEl.innerHTML = '<div class="conv-empty">No conversation history available</div>';
      } else {
        modalConversationEl.innerHTML = conversation.map(msg => `
          <div class="conv-msg ${msg.role}">
            ${escapeHtml(msg.content)}
          </div>
        `).join("");
      }

      modalEl.classList.add("active");
    }

    function closeModal() {
      modalEl.classList.remove("active");
    }

    // Close modal when clicking outside
    modalEl.addEventListener("click", (e) => {
      if (e.target === modalEl) {
        closeModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modalEl.classList.contains("active")) {
        closeModal();
      }
    });

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Initial load
    fetchSummary();
    fetchSessions();
  </script>
</body>
</html>
