<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Modifiers Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .app-header {
      background: #1976d2;
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-header a {
      color: #bbdefb;
      text-decoration: none;
      font-size: 14px;
      margin-left: 16px;
    }
    .app-header a:hover {
      color: #fff;
    }
    .layout {
      display: flex;
      height: calc(100vh - 52px);
    }
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f5f5f5;
    }
    .item-type-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      margin: 0;
      list-style: none;
    }
    .item-type-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-type-item:hover {
      background: #f5f5f5;
    }
    .item-type-item.active {
      background: #e3f2fd;
      border-left: 3px solid #1976d2;
    }
    .item-type-name {
      font-weight: 500;
    }
    .item-type-meta {
      font-size: 12px;
      color: #666;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-state h3 {
      margin: 0 0 8px;
      color: #333;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .section-header {
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9f9f9;
      border-radius: 8px 8px 0 0;
    }
    .attribute-card {
      border-bottom: 1px solid #f0f0f0;
      padding: 16px;
    }
    .attribute-card:last-child {
      border-bottom: none;
    }
    .attribute-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .attribute-title {
      font-weight: 600;
      font-size: 15px;
    }
    .attribute-slug {
      font-size: 12px;
      color: #666;
      font-family: monospace;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }
    .attribute-meta {
      display: flex;
      gap: 8px;
      font-size: 12px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge.required {
      background: #fff3e0;
      color: #e65100;
    }
    .badge.optional {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .badge.single {
      background: #e3f2fd;
      color: #1565c0;
    }
    .badge.multi {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    .options-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .options-table th {
      text-align: left;
      padding: 8px 12px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 500;
      color: #666;
    }
    .options-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    .options-table tr:last-child td {
      border-bottom: none;
    }
    .options-table tr:hover {
      background: #fafafa;
    }
    .price-modifier {
      font-family: monospace;
      font-weight: 500;
    }
    .price-modifier.positive {
      color: #2e7d32;
    }
    .price-modifier.zero {
      color: #999;
    }
    .price-modifier.negative {
      color: #c62828;
    }
    .availability-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .availability-badge.available {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .availability-badge.unavailable {
      background: #ffebee;
      color: #c62828;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }
    .btn.primary {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }
    .btn.primary:hover {
      background: #1565c0;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 11px;
    }
    .btn.danger {
      color: #c62828;
      border-color: #ef9a9a;
    }
    .btn.danger:hover {
      background: #ffebee;
    }
    .btn-group {
      display: flex;
      gap: 6px;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .modal {
      background: #fff;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    .modal-close:hover {
      color: #333;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1976d2;
    }
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row .form-group {
      flex: 1;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input {
      width: auto;
    }
    .type-info {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .type-info h2 {
      margin: 0 0 8px;
      font-size: 20px;
    }
    .type-info .slug {
      font-family: monospace;
      background: #e0e0e0;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 13px;
    }
    .type-info .used-by {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    .add-option-row td {
      background: #fafafa;
    }
    .inline-input {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    .inline-input:focus {
      outline: none;
      border-color: #1976d2;
    }
    .inline-input.price {
      width: 80px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div>Modifiers Admin</div>
    <div>
      <a href="/static/index.html">Customer Chat</a>
      <a href="/static/admin_menu.html">Menu</a>
      <a href="/static/admin_orders.html">Orders</a>
      <a href="/static/admin_ingredients.html">Ingredients</a>
      <a href="/static/admin_modifiers.html"><strong>Modifiers</strong></a>
      <a href="/static/admin_item_types.html">Item Types</a>
      <a href="/static/admin_modifier_categories.html">Categories</a>
      <a href="/static/admin_stores.html">Stores</a>
      <a href="/static/admin_analytics.html">Analytics</a>
      <a href="/static/admin_company.html">Company</a>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="sidebar-header">
        <span>Item Types</span>
        <button class="btn primary small" onclick="showAddItemTypeModal()">+ Add</button>
      </div>
      <ul class="item-type-list" id="itemTypeList">
        <!-- Populated by JavaScript -->
      </ul>
    </div>

    <div class="main-content" id="mainContent">
      <div class="empty-state">
        <h3>Select an Item Type</h3>
        <p>Choose an item type from the sidebar to view and edit its modifiers.</p>
      </div>
    </div>
  </div>

  <!-- Add Item Type Modal -->
  <div class="modal-overlay hidden" id="addItemTypeModal">
    <div class="modal">
      <div class="modal-header">
        <span id="itemTypeModalTitle">Add Item Type</span>
        <button class="modal-close" onclick="closeModal('addItemTypeModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Slug (unique identifier)</label>
          <input type="text" id="itemTypeSlug" placeholder="e.g., coffee, sandwich">
        </div>
        <div class="form-group">
          <label>Display Name</label>
          <input type="text" id="itemTypeDisplayName" placeholder="e.g., Coffee, Sandwich">
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="itemTypeConfigurable" checked>
            <label for="itemTypeConfigurable">Is Configurable (has customizable attributes)</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addItemTypeModal')">Cancel</button>
        <button class="btn primary" onclick="saveItemType()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Attribute Modal -->
  <div class="modal-overlay hidden" id="addAttributeModal">
    <div class="modal">
      <div class="modal-header">
        <span id="attributeModalTitle">Add Attribute</span>
        <button class="modal-close" onclick="closeModal('addAttributeModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Slug</label>
            <input type="text" id="attrSlug" placeholder="e.g., milk, size">
          </div>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="attrDisplayName" placeholder="e.g., Milk, Size">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Input Type</label>
            <select id="attrInputType">
              <option value="single_select">Single Select</option>
              <option value="multi_select">Multi Select</option>
              <option value="boolean">Boolean (Yes/No)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Display Order</label>
            <input type="number" id="attrDisplayOrder" value="0" min="0">
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="attrRequired">
            <label for="attrRequired">Required</label>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="attrAllowNone">
            <label for="attrAllowNone">Allow "None" option</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addAttributeModal')">Cancel</button>
        <button class="btn primary" onclick="saveAttribute()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add Option Modal -->
  <div class="modal-overlay hidden" id="addOptionModal">
    <div class="modal">
      <div class="modal-header">
        <span id="optionModalTitle">Add Option</span>
        <button class="modal-close" onclick="closeModal('addOptionModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Slug</label>
            <input type="text" id="optSlug" placeholder="e.g., oat, vanilla">
          </div>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="optDisplayName" placeholder="e.g., Oat Milk, Vanilla">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Price Modifier ($)</label>
            <input type="number" id="optPriceModifier" value="0.00" step="0.01">
          </div>
          <div class="form-group">
            <label>Display Order</label>
            <input type="number" id="optDisplayOrder" value="0" min="0">
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="optIsDefault">
            <label for="optIsDefault">Default selection</label>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="optIsAvailable" checked>
            <label for="optIsAvailable">Available (uncheck to 86)</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('addOptionModal')">Cancel</button>
        <button class="btn primary" onclick="saveOption()">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let itemTypes = [];
    let selectedItemType = null;
    let editingItemTypeId = null;
    let editingAttributeId = null;
    let editingOptionId = null;
    let currentAttributeId = null; // For adding options

    // Fetch all item types
    async function loadItemTypes() {
      try {
        const resp = await fetch(`${API_BASE}/admin/modifiers/item-types`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        itemTypes = await resp.json();
        renderItemTypeList();

        // Re-select previously selected type if it still exists
        if (selectedItemType) {
          const found = itemTypes.find(it => it.id === selectedItemType.id);
          if (found) {
            selectItemType(found);
          } else {
            selectedItemType = null;
            renderMainContent();
          }
        }
      } catch (err) {
        console.error("Error loading item types:", err);
        alert("Failed to load item types. Check console for details.");
      }
    }

    function renderItemTypeList() {
      const list = document.getElementById("itemTypeList");
      if (itemTypes.length === 0) {
        list.innerHTML = '<li style="padding: 20px; text-align: center; color: #666;">No item types yet</li>';
        return;
      }

      list.innerHTML = itemTypes.map(it => `
        <li class="item-type-item ${selectedItemType?.id === it.id ? 'active' : ''}"
            onclick="selectItemType(${JSON.stringify(it).replace(/"/g, '&quot;')})">
          <div>
            <div class="item-type-name">${it.display_name}</div>
            <div class="item-type-meta">${it.attribute_definitions.length} attributes</div>
          </div>
          <div class="item-type-meta">${it.menu_item_count} items</div>
        </li>
      `).join('');
    }

    function selectItemType(itemType) {
      selectedItemType = itemType;
      renderItemTypeList();
      renderMainContent();
    }

    function renderMainContent() {
      const main = document.getElementById("mainContent");

      if (!selectedItemType) {
        main.innerHTML = `
          <div class="empty-state">
            <h3>Select an Item Type</h3>
            <p>Choose an item type from the sidebar to view and edit its modifiers.</p>
          </div>
        `;
        return;
      }

      const it = selectedItemType;
      const usedByText = it.menu_item_count > 0
        ? `Used by ${it.menu_item_count} menu item${it.menu_item_count > 1 ? 's' : ''}`
        : 'Not used by any menu items';

      main.innerHTML = `
        <div class="type-info">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h2>${it.display_name} <span class="slug">${it.slug}</span></h2>
              <div class="used-by">${usedByText}</div>
            </div>
            <div class="btn-group">
              <button class="btn small" onclick="showEditItemTypeModal(${it.id})">Edit</button>
              <button class="btn small danger" onclick="deleteItemType(${it.id})" ${it.menu_item_count > 0 ? 'disabled title="Cannot delete: in use by menu items"' : ''}>Delete</button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <span>Attributes & Options</span>
            <button class="btn primary small" onclick="showAddAttributeModal(${it.id})">+ Add Attribute</button>
          </div>
          ${renderAttributes(it.attribute_definitions)}
        </div>
      `;
    }

    function renderAttributes(attributes) {
      if (attributes.length === 0) {
        return `
          <div style="padding: 40px; text-align: center; color: #666;">
            <p>No attributes defined yet.</p>
            <p style="font-size: 13px;">Add attributes like "size", "milk", or "syrup" to customize this item type.</p>
          </div>
        `;
      }

      return attributes.map(attr => `
        <div class="attribute-card">
          <div class="attribute-header">
            <div>
              <span class="attribute-title">${attr.display_name}</span>
              <span class="attribute-slug">${attr.slug}</span>
            </div>
            <div class="btn-group">
              <button class="btn small" onclick="showEditAttributeModal(${attr.id})">Edit</button>
              <button class="btn small danger" onclick="deleteAttribute(${attr.id})">Delete</button>
            </div>
          </div>
          <div class="attribute-meta" style="margin-bottom: 12px;">
            <span class="badge ${attr.is_required ? 'required' : 'optional'}">${attr.is_required ? 'Required' : 'Optional'}</span>
            <span class="badge ${attr.input_type === 'multi_select' ? 'multi' : 'single'}">${formatInputType(attr.input_type)}</span>
          </div>
          ${renderOptionsTable(attr)}
        </div>
      `).join('');
    }

    function formatInputType(type) {
      switch(type) {
        case 'single_select': return 'Single Select';
        case 'multi_select': return 'Multi Select';
        case 'boolean': return 'Yes/No';
        default: return type;
      }
    }

    function renderOptionsTable(attr) {
      return `
        <table class="options-table">
          <thead>
            <tr>
              <th>Option</th>
              <th>Slug</th>
              <th>Price Modifier</th>
              <th>Status</th>
              <th style="width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${attr.options.length === 0 ? `
              <tr>
                <td colspan="5" style="text-align: center; color: #666; padding: 20px;">
                  No options yet. Add some below.
                </td>
              </tr>
            ` : attr.options.map(opt => `
              <tr>
                <td>
                  <strong>${opt.display_name}</strong>
                  ${opt.is_default ? '<span class="badge" style="background:#e3f2fd;color:#1565c0;margin-left:6px;">Default</span>' : ''}
                </td>
                <td><code style="font-size: 12px; background: #f5f5f5; padding: 2px 4px; border-radius: 2px;">${opt.slug}</code></td>
                <td>
                  <span class="price-modifier ${opt.price_modifier > 0 ? 'positive' : opt.price_modifier < 0 ? 'negative' : 'zero'}">
                    ${opt.price_modifier > 0 ? '+' : ''}$${opt.price_modifier.toFixed(2)}
                  </span>
                </td>
                <td>
                  <span class="availability-badge ${opt.is_available ? 'available' : 'unavailable'}">
                    ${opt.is_available ? 'Available' : '86\'d'}
                  </span>
                </td>
                <td>
                  <div class="btn-group">
                    <button class="btn small" onclick="showEditOptionModal(${opt.id})">Edit</button>
                    <button class="btn small danger" onclick="deleteOption(${opt.id})">Delete</button>
                  </div>
                </td>
              </tr>
            `).join('')}
            <tr class="add-option-row">
              <td colspan="5">
                <button class="btn small" onclick="showAddOptionModal(${attr.id})">+ Add Option</button>
              </td>
            </tr>
          </tbody>
        </table>
      `;
    }

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      // Reset form state
      editingItemTypeId = null;
      editingAttributeId = null;
      editingOptionId = null;
    }

    // Item Type CRUD
    function showAddItemTypeModal() {
      editingItemTypeId = null;
      document.getElementById('itemTypeModalTitle').textContent = 'Add Item Type';
      document.getElementById('itemTypeSlug').value = '';
      document.getElementById('itemTypeDisplayName').value = '';
      document.getElementById('itemTypeConfigurable').checked = true;
      showModal('addItemTypeModal');
    }

    function showEditItemTypeModal(id) {
      const it = itemTypes.find(t => t.id === id);
      if (!it) return;

      editingItemTypeId = id;
      document.getElementById('itemTypeModalTitle').textContent = 'Edit Item Type';
      document.getElementById('itemTypeSlug').value = it.slug;
      document.getElementById('itemTypeDisplayName').value = it.display_name;
      document.getElementById('itemTypeConfigurable').checked = it.is_configurable;
      showModal('addItemTypeModal');
    }

    async function saveItemType() {
      const slug = document.getElementById('itemTypeSlug').value.trim();
      const displayName = document.getElementById('itemTypeDisplayName').value.trim();
      const isConfigurable = document.getElementById('itemTypeConfigurable').checked;

      if (!slug || !displayName) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        const url = editingItemTypeId
          ? `${API_BASE}/admin/modifiers/item-types/${editingItemTypeId}`
          : `${API_BASE}/admin/modifiers/item-types`;
        const method = editingItemTypeId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            slug,
            display_name: displayName,
            is_configurable: isConfigurable
          })
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to save');
        }

        closeModal('addItemTypeModal');
        await loadItemTypes();
      } catch (err) {
        alert(err.message);
      }
    }

    async function deleteItemType(id) {
      if (!confirm('Are you sure you want to delete this item type? This will also delete all its attributes and options.')) {
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/admin/modifiers/item-types/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to delete');
        }

        if (selectedItemType?.id === id) {
          selectedItemType = null;
        }
        await loadItemTypes();
        renderMainContent();
      } catch (err) {
        alert(err.message);
      }
    }

    // Attribute CRUD
    function showAddAttributeModal(itemTypeId) {
      editingAttributeId = null;
      document.getElementById('attributeModalTitle').textContent = 'Add Attribute';
      document.getElementById('attrSlug').value = '';
      document.getElementById('attrDisplayName').value = '';
      document.getElementById('attrInputType').value = 'single_select';
      document.getElementById('attrDisplayOrder').value = '0';
      document.getElementById('attrRequired').checked = false;
      document.getElementById('attrAllowNone').checked = false;
      showModal('addAttributeModal');
    }

    function showEditAttributeModal(attrId) {
      const attr = selectedItemType?.attribute_definitions.find(a => a.id === attrId);
      if (!attr) return;

      editingAttributeId = attrId;
      document.getElementById('attributeModalTitle').textContent = 'Edit Attribute';
      document.getElementById('attrSlug').value = attr.slug;
      document.getElementById('attrDisplayName').value = attr.display_name;
      document.getElementById('attrInputType').value = attr.input_type;
      document.getElementById('attrDisplayOrder').value = attr.display_order;
      document.getElementById('attrRequired').checked = attr.is_required;
      document.getElementById('attrAllowNone').checked = attr.allow_none;
      showModal('addAttributeModal');
    }

    async function saveAttribute() {
      const slug = document.getElementById('attrSlug').value.trim();
      const displayName = document.getElementById('attrDisplayName').value.trim();
      const inputType = document.getElementById('attrInputType').value;
      const displayOrder = parseInt(document.getElementById('attrDisplayOrder').value) || 0;
      const isRequired = document.getElementById('attrRequired').checked;
      const allowNone = document.getElementById('attrAllowNone').checked;

      if (!slug || !displayName) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        const url = editingAttributeId
          ? `${API_BASE}/admin/modifiers/attributes/${editingAttributeId}`
          : `${API_BASE}/admin/modifiers/item-types/${selectedItemType.id}/attributes`;
        const method = editingAttributeId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            slug,
            display_name: displayName,
            input_type: inputType,
            display_order: displayOrder,
            is_required: isRequired,
            allow_none: allowNone
          })
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to save');
        }

        closeModal('addAttributeModal');
        await loadItemTypes();
      } catch (err) {
        alert(err.message);
      }
    }

    async function deleteAttribute(attrId) {
      if (!confirm('Are you sure you want to delete this attribute? This will also delete all its options.')) {
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/admin/modifiers/attributes/${attrId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to delete');
        }

        await loadItemTypes();
      } catch (err) {
        alert(err.message);
      }
    }

    // Option CRUD
    function showAddOptionModal(attrId) {
      editingOptionId = null;
      currentAttributeId = attrId;
      document.getElementById('optionModalTitle').textContent = 'Add Option';
      document.getElementById('optSlug').value = '';
      document.getElementById('optDisplayName').value = '';
      document.getElementById('optPriceModifier').value = '0.00';
      document.getElementById('optDisplayOrder').value = '0';
      document.getElementById('optIsDefault').checked = false;
      document.getElementById('optIsAvailable').checked = true;
      showModal('addOptionModal');
    }

    function showEditOptionModal(optId) {
      // Find the option across all attributes
      let option = null;
      let attrId = null;
      for (const attr of selectedItemType?.attribute_definitions || []) {
        const found = attr.options.find(o => o.id === optId);
        if (found) {
          option = found;
          attrId = attr.id;
          break;
        }
      }
      if (!option) return;

      editingOptionId = optId;
      currentAttributeId = attrId;
      document.getElementById('optionModalTitle').textContent = 'Edit Option';
      document.getElementById('optSlug').value = option.slug;
      document.getElementById('optDisplayName').value = option.display_name;
      document.getElementById('optPriceModifier').value = option.price_modifier.toFixed(2);
      document.getElementById('optDisplayOrder').value = option.display_order;
      document.getElementById('optIsDefault').checked = option.is_default;
      document.getElementById('optIsAvailable').checked = option.is_available;
      showModal('addOptionModal');
    }

    async function saveOption() {
      const slug = document.getElementById('optSlug').value.trim();
      const displayName = document.getElementById('optDisplayName').value.trim();
      const priceModifier = parseFloat(document.getElementById('optPriceModifier').value) || 0;
      const displayOrder = parseInt(document.getElementById('optDisplayOrder').value) || 0;
      const isDefault = document.getElementById('optIsDefault').checked;
      const isAvailable = document.getElementById('optIsAvailable').checked;

      if (!slug || !displayName) {
        alert('Please fill in all required fields.');
        return;
      }

      try {
        const url = editingOptionId
          ? `${API_BASE}/admin/modifiers/options/${editingOptionId}`
          : `${API_BASE}/admin/modifiers/attributes/${currentAttributeId}/options`;
        const method = editingOptionId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            slug,
            display_name: displayName,
            price_modifier: priceModifier,
            display_order: displayOrder,
            is_default: isDefault,
            is_available: isAvailable
          })
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to save');
        }

        closeModal('addOptionModal');
        await loadItemTypes();
      } catch (err) {
        alert(err.message);
      }
    }

    async function deleteOption(optId) {
      if (!confirm('Are you sure you want to delete this option?')) {
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/admin/modifiers/options/${optId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || 'Failed to delete');
        }

        await loadItemTypes();
      } catch (err) {
        alert(err.message);
      }
    }

    // Initialize
    loadItemTypes();
  </script>
</body>
</html>
