<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orders Admin</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
    }
    .app-header {
      background: #1976d2;
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-header a {
      color: #bbdefb;
      text-decoration: none;
      font-size: 14px;
      margin-left: 16px;
    }
    .app-header a:hover {
      color: #fff;
    }
    .main-content {
      display: flex;
      height: calc(100vh - 52px);
    }

    .sidebar {
      width: 55%;
      max-width: 800px;
      min-width: 650px;
      border-right: 1px solid #ddd;
      padding: 16px;
      box-sizing: border-box;
      background: #fff;
      display: flex;
      flex-direction: column;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .filter-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    select, button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      cursor: pointer;
      background: #fafafa;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
    }

    button[disabled] {
      background: #ccc;
      cursor: default;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
    }

    tr:hover {
      background: #f0f4ff;
      cursor: pointer;
    }

    tr.selected {
      background: #dbeafe;
    }

    .pagination {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .details {
      flex: 1;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .details-card {
      background: #fff;
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .details-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-pending {
      background: #fef9c3;
      color: #92400e;
    }

    .status-confirmed {
      background: #dcfce7;
      color: #166534;
    }

    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 4px 16px;
      font-size: 13px;
    }

    .items-list {
      margin-top: 8px;
    }

    .item-card {
      border-top: 1px solid #eee;
      padding: 6px 0;
      font-size: 13px;
    }

    .item-card:first-child {
      border-top: none;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .muted {
      color: #666;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div>Orders Admin</div>
    <div>
      <a href="/static/index.html">Customer Chat</a>
      <a href="/static/admin_menu.html">Menu</a>
      <a href="/static/admin_ingredients.html">Ingredients (86)</a>
      <a href="/static/admin_modifiers.html">Modifiers</a>
      <a href="/static/admin_item_types.html">Item Types</a>
      <a href="/static/admin_stores.html">Stores</a>
      <a href="/static/admin_analytics.html">Analytics</a>
      <a href="/static/admin_company.html">Company</a>
    </div>
  </div>
  <div class="main-content">
  <div class="sidebar">
    <div class="header">
      <h1 style="font-size:18px; margin:0;">Orders</h1>
      <div class="filter-group">
        <label for="statusFilter" style="font-size:13px;">Status:</label>
        <select id="statusFilter">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
        </select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Store</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Status</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <!-- Rows injected here -->
      </tbody>
    </table>

    <div class="pagination">
      <div>
        <button id="prevPage">Prev</button>
        <button id="nextPage">Next</button>
      </div>
      <div id="pageInfo" class="muted"></div>
    </div>
  </div>

  <div class="details">
    <div class="details-card" id="detailsCard">
      <div class="details-header">
        <h2>Order details</h2>
        <span id="statusPill" class="status-pill status-pending" style="display:none;"></span>
      </div>
      <div id="detailsContent" class="muted">
        Select an order from the list to view details.
      </div>
    </div>

    <div class="nav-buttons">
      <button id="prevOrder" disabled>Prev order</button>
      <button id="nextOrder" disabled>Next order</button>
    </div>
  </div>
  </div>

  <script>
    const API_BASE = "";

    // Auth credentials storage (cached after first successful auth)
    let authCredentials = null;

    // Authenticated fetch helper - prompts for credentials on 401
    async function authFetch(url, options = {}) {
      let response = await fetch(url, { ...options, credentials: 'include' });

      if (response.status === 401 && authCredentials) {
        response = await fetch(url, {
          ...options,
          headers: { ...options.headers, 'Authorization': 'Basic ' + authCredentials }
        });
      }

      if (response.status === 401) {
        const username = prompt('Admin username:');
        if (!username) throw new Error('Authentication cancelled');
        const password = prompt('Admin password:');
        if (!password) throw new Error('Authentication cancelled');

        authCredentials = btoa(username + ':' + password);

        response = await fetch(url, {
          ...options,
          headers: { ...options.headers, 'Authorization': 'Basic ' + authCredentials }
        });

        if (response.status === 401) {
          authCredentials = null;
          throw new Error('Invalid credentials');
        }
      }

      return response;
    }

    // Store ID to name and timezone mapping - loaded dynamically from API
    let STORE_DATA = {};

    async function loadStores() {
      try {
        const resp = await fetch("/stores");
        if (resp.ok) {
          const stores = await resp.json();
          STORE_DATA = {};
          stores.forEach(store => {
            STORE_DATA[store.store_id] = {
              name: store.name,
              timezone: store.timezone || "America/New_York"
            };
          });
        }
      } catch (err) {
        console.error("Failed to load stores:", err);
      }
    }

    function getStoreName(storeId) {
      if (!storeId) return "-";
      return STORE_DATA[storeId]?.name || storeId;
    }

    function getStoreTimezone(storeId) {
      if (!storeId) return "America/New_York";
      return STORE_DATA[storeId]?.timezone || "America/New_York";
    }

    // Format a UTC datetime string in the store's timezone
    function formatInStoreTimezone(utcDateStr, storeId) {
      if (!utcDateStr) return "";
      try {
        // Normalize date string - handle cases like "2025-12-27T22:18:32.290525+00:00Z"
        // which has both a timezone offset AND a Z suffix (invalid ISO 8601)
        let normalized = utcDateStr;
        if (normalized.includes('+') && normalized.endsWith('Z')) {
          normalized = normalized.slice(0, -1);  // Remove trailing Z
        }
        if (normalized.includes('-') && normalized.endsWith('Z') && normalized.lastIndexOf('-') > 10) {
          // Has negative offset like "-05:00Z" - remove trailing Z
          normalized = normalized.slice(0, -1);
        }

        const date = new Date(normalized);
        if (isNaN(date.getTime())) return utcDateStr;

        const timezone = getStoreTimezone(storeId);
        return date.toLocaleString("en-US", {
          timeZone: timezone,
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        });
      } catch (err) {
        console.error("Failed to format date:", err);
        return utcDateStr;
      }
    }

    let currentPage = 1;
    let currentStatus = "";
    let lastPageSize = 10;
    let ordersCache = [];
    let selectedIndex = -1;

    const statusFilter = document.getElementById("statusFilter");
    const ordersBody = document.getElementById("ordersBody");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");
    const detailsContent = document.getElementById("detailsContent");
    const statusPill = document.getElementById("statusPill");
    const prevOrderBtn = document.getElementById("prevOrder");
    const nextOrderBtn = document.getElementById("nextOrder");

    statusFilter.addEventListener("change", () => {
      currentStatus = statusFilter.value;
      currentPage = 1;
      selectedIndex = -1;
      fetchOrders();
    });

    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        selectedIndex = -1;
        fetchOrders();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (!nextPageBtn.disabled) {
        currentPage++;
        selectedIndex = -1;
        fetchOrders();
      }
    });

    prevOrderBtn.addEventListener("click", () => {
      if (selectedIndex > 0) {
        selectOrder(selectedIndex - 1);
      }
    });

    nextOrderBtn.addEventListener("click", () => {
      if (selectedIndex >= 0 && selectedIndex < ordersCache.length - 1) {
        selectOrder(selectedIndex + 1);
      }
    });

    async function fetchOrders() {
      try {
        const params = new URLSearchParams();
        params.append("page", String(currentPage));
        params.append("page_size", String(lastPageSize));
        if (currentStatus) {
          params.append("status", currentStatus);
        }

        const resp = await authFetch(`${API_BASE}/admin/orders?${params.toString()}`);
        if (!resp.ok) {
          throw new Error(`Failed to load orders: ${resp.status}`);
        }
        const data = await resp.json();

        ordersCache = data.items;
        lastPageSize = data.page_size || 10;

        renderOrdersTable();
        pageInfo.textContent = `Page ${data.page} • ${data.total} total orders`;
        prevPageBtn.disabled = data.page <= 1;
        nextPageBtn.disabled = !data.has_next;

        if (selectedIndex === -1) {
          detailsContent.textContent = "Select an order from the list to view details.";
          statusPill.style.display = "none";
          prevOrderBtn.disabled = true;
          nextOrderBtn.disabled = true;
        }
      } catch (err) {
        console.error(err);
        ordersBody.innerHTML = `<tr><td colspan="7" style="color:red;">Error loading orders</td></tr>`;
      }
    }

    function renderOrdersTable() {
      ordersBody.innerHTML = "";

      if (!ordersCache.length) {
        ordersBody.innerHTML = `<tr><td colspan="7" class="muted">No orders found</td></tr>`;
        return;
      }

      ordersCache.forEach((order, idx) => {
        const tr = document.createElement("tr");
        if (idx === selectedIndex) {
          tr.classList.add("selected");
        }

        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${getStoreName(order.store_id)}</td>
          <td>${order.customer_name || ""}</td>
          <td>${order.phone || ""}</td>
          <td>${order.customer_email || ""}</td>
          <td>${order.status}</td>
          <td>$${order.total_price.toFixed(2)}</td>
        `;

        tr.addEventListener("click", () => {
          selectOrder(idx);
        });

        ordersBody.appendChild(tr);
      });
    }

    async function selectOrder(idx) {
      if (idx < 0 || idx >= ordersCache.length) return;

      selectedIndex = idx;
      renderOrdersTable();

      const order = ordersCache[idx];
      await loadOrderDetails(order.id);

      prevOrderBtn.disabled = selectedIndex <= 0;
      nextOrderBtn.disabled = selectedIndex >= ordersCache.length - 1;
    }

    async function loadOrderDetails(orderId) {
      try {
        const resp = await authFetch(`${API_BASE}/admin/orders/${orderId}`);
        if (!resp.ok) {
          throw new Error(`Failed to load order ${orderId}: ${resp.status}`);
        }
        const order = await resp.json();

        const statusClass =
          order.status === "confirmed"
            ? "status-confirmed"
            : "status-pending";

        statusPill.style.display = "inline-block";
        statusPill.className = `status-pill ${statusClass}`;
        statusPill.textContent = order.status;

        // Helper function to build item display key for consolidation
        function buildItemKey(item) {
          const parts = [item.menu_item_name];

          // Add config details that differentiate items
          if (item.toasted === true) parts.push("toasted");
          if (item.toasted === false) parts.push("not toasted");
          if (item.size) parts.push(item.size);
          if (item.bread) parts.push(item.bread);
          if (item.protein && item.protein.toLowerCase() !== "none") parts.push(item.protein);
          if (item.cheese && item.cheese.toLowerCase() !== "none") parts.push(item.cheese);

          // Add drink config
          if (item.item_config) {
            if (item.item_config.size) parts.push(item.item_config.size);
            if (item.item_config.style) parts.push(item.item_config.style);
            if (item.item_config.milk && item.item_config.milk.toLowerCase() !== "none") {
              parts.push(item.item_config.milk);
            }
            if (item.item_config.flavor_syrup) parts.push(item.item_config.flavor_syrup);
            if (item.item_config.sweetener) {
              parts.push(item.item_config.sweetener);
              parts.push(item.item_config.sweetener_quantity || 1);
            }
          }

          // Add toppings and sauces
          const toppings = (item.toppings || []).filter(t => t && t.toLowerCase() !== "none").sort();
          const sauces = (item.sauces || []).sort();
          parts.push(toppings.join(","));
          parts.push(sauces.join(","));

          return parts.join("|");
        }

        // Consolidate identical items
        const consolidatedItems = {};
        order.items.forEach(item => {
          const key = buildItemKey(item);
          if (!consolidatedItems[key]) {
            consolidatedItems[key] = {
              ...item,
              quantity: item.quantity || 1,
              line_total: item.line_total || 0
            };
          } else {
            consolidatedItems[key].quantity += (item.quantity || 1);
            consolidatedItems[key].line_total += (item.line_total || 0);
          }
        });

        const itemsHtml = Object.values(consolidatedItems)
          .map((item) => {
            const extras = [];
            if (item.toasted === true) extras.push("toasted");
            if (item.toasted === false) extras.push("not toasted");
            if (item.size) extras.push(item.size);
            if (item.bread) extras.push(item.bread);
            // Filter out "none" values for protein and cheese
            if (item.protein && item.protein.toLowerCase() !== "none") extras.push(item.protein);
            if (item.cheese && item.cheese.toLowerCase() !== "none") extras.push(item.cheese);
            const extrasStr = extras.join(" • ");

            // Filter out "none" values from toppings array
            const filteredToppings = (item.toppings || []).filter(t => t && t.toLowerCase() !== "none");
            const toppings = filteredToppings.length
              ? `Toppings: ${filteredToppings.join(", ")}`
              : "";
            const sauces = item.sauces && item.sauces.length
              ? `Sauces: ${item.sauces.join(", ")}`
              : "";

            // Handle item_config for coffee/drinks
            let configStr = "";
            if (item.item_config) {
              const configParts = [];
              if (item.item_config.size) configParts.push(item.item_config.size);
              if (item.item_config.style) {
                configParts.push(item.item_config.style);
              }
              if (item.item_config.milk && item.item_config.milk.toLowerCase() !== "none") {
                configParts.push(item.item_config.milk.replace(/_/g, " "));
              }
              // Handle flavor_syrup (new field name) or syrup (legacy)
              const syrupValue = item.item_config.flavor_syrup || item.item_config.syrup;
              if (syrupValue) {
                const syrups = Array.isArray(syrupValue) ? syrupValue : [syrupValue];
                syrups.forEach(s => {
                  const formatted = s.replace(/_/g, " ");
                  // Don't add "syrup" if it's already in the name
                  configParts.push(formatted.toLowerCase().includes("syrup") ? formatted : formatted + " syrup");
                });
              }
              // Handle sweetener with quantity
              if (item.item_config.sweetener) {
                const sweeteners = Array.isArray(item.item_config.sweetener) ? item.item_config.sweetener : [item.item_config.sweetener];
                const sweetenerQty = item.item_config.sweetener_quantity || 1;
                sweeteners.filter(s => s).forEach(s => {
                  const formatted = s.replace(/_/g, " ");
                  if (sweetenerQty > 1) {
                    configParts.push(`${sweetenerQty} ${formatted}s`);
                  } else {
                    configParts.push(formatted);
                  }
                });
              }
              if (item.item_config.extras) {
                const cfgExtras = Array.isArray(item.item_config.extras) ? item.item_config.extras : [item.item_config.extras];
                cfgExtras.filter(e => e).forEach(e => configParts.push(e.replace(/_/g, " ")));
              }
              configStr = configParts.join(" • ");
            }

            // For drinks with item_config, use configStr; otherwise use extrasStr
            const displayExtras = item.item_config ? configStr : extrasStr;

            return `
              <div class="item-card">
                <div><strong>${item.quantity}× ${item.menu_item_name}</strong></div>
                <div class="muted">${displayExtras}</div>
                <div class="muted">
                  ${toppings}<br/>
                  ${sauces}
                </div>
                <div><strong>$${item.line_total.toFixed(2)}</strong></div>
              </div>
            `;
          })
          .join("");

        const formattedCreatedAt = formatInStoreTimezone(order.created_at, order.store_id);

        // Build price breakdown section
        const hasSubtotal = order.subtotal !== null && order.subtotal !== undefined;
        const cityTax = order.city_tax || 0;
        const stateTax = order.state_tax || 0;
        const deliveryFee = order.delivery_fee || 0;
        const total = order.total_price || 0;

        detailsContent.innerHTML = `
          <div class="details-grid">
            <div><strong>Order ID:</strong> ${order.id}</div>
            <div><strong>Store:</strong> ${getStoreName(order.store_id)}</div>
            <div><strong>Name:</strong> ${order.customer_name || ""}</div>
            <div><strong>Phone:</strong> ${order.phone || ""}</div>
            <div><strong>Email:</strong> ${order.customer_email || ""}</div>
            <div><strong>Order Type:</strong> ${order.order_type || "pickup"}</div>
            ${order.delivery_address ? `<div><strong>Delivery Address:</strong> ${order.delivery_address}</div>` : ''}
            <div><strong>Payment:</strong> ${order.payment_method || ""} (${order.payment_status || "unpaid"})</div>
            <div><strong>Ready Time:</strong> ${order.pickup_time || ""}</div>
            <div><strong>Created:</strong> ${formattedCreatedAt}</div>
          </div>
          <div class="items-list">
            <h3 style="font-size:14px; margin:8px 0 4px;">Items</h3>
            ${itemsHtml || '<div class="muted">No items on this order</div>'}
          </div>
          <div class="price-breakdown" style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
            <h3 style="font-size: 14px; margin: 0 0 8px 0;">Price Breakdown</h3>
            ${hasSubtotal ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>Subtotal:</span>
              <span>$${order.subtotal.toFixed(2)}</span>
            </div>
            ` : ''}
            ${cityTax > 0 ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: #666;">
              <span>City Tax:</span>
              <span>$${cityTax.toFixed(2)}</span>
            </div>
            ` : ''}
            ${stateTax > 0 ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: #666;">
              <span>State Tax:</span>
              <span>$${stateTax.toFixed(2)}</span>
            </div>
            ` : ''}
            ${deliveryFee > 0 ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: #666;">
              <span>Delivery Fee:</span>
              <span>$${deliveryFee.toFixed(2)}</span>
            </div>
            ` : ''}
            <div style="display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-weight: 600; font-size: 15px;">
              <span>Total:</span>
              <span>$${total.toFixed(2)}</span>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        detailsContent.innerHTML = `<span style="color:red;">Error loading order details</span>`;
        statusPill.style.display = "none";
      }
    }

    // Initialize - load stores first so names are available
    async function init() {
      await loadStores();
      fetchOrders();
    }
    init();
  </script>
</body>
</html>
