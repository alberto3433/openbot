<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Zucker's Order Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* =====================================================
       Theme System - CSS Custom Properties
       ===================================================== */
    :root {
      /* Brand Colors - Zucker's warm palette */
      --brand-primary: #D4754E;
      --brand-primary-hover: #C46842;
      --brand-secondary: #8B5A2B;
      --brand-accent: #F5A623;

      /* Light Theme (default) */
      --bg-primary: #FAF7F4;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F5F0EB;
      --bg-input: #FFFFFF;

      --text-primary: #2D2A26;
      --text-secondary: #5C574F;
      --text-tertiary: #8A847A;
      --text-inverse: #FFFFFF;

      --border-light: #E8E2DA;
      --border-medium: #D4CCC2;

      --shadow-sm: 0 1px 3px rgba(45, 42, 38, 0.06);
      --shadow-md: 0 4px 12px rgba(45, 42, 38, 0.08);
      --shadow-lg: 0 8px 24px rgba(45, 42, 38, 0.12);

      /* Component Colors */
      --header-bg: linear-gradient(135deg, #D4754E 0%, #C46842 100%);
      --chat-bg: #FDFCFB;
      --user-bubble-bg: var(--brand-primary);
      --user-bubble-text: #FFFFFF;
      --assistant-bubble-bg: #FFFFFF;
      --assistant-bubble-border: #E8E2DA;
      --assistant-bubble-text: var(--text-primary);

      --input-border: #D4CCC2;
      --input-focus-border: var(--brand-primary);
      --input-focus-shadow: 0 0 0 3px rgba(212, 117, 78, 0.15);

      --badge-bg: #FFF3E8;
      --badge-text: #B35E2C;
      --badge-delivery-bg: #FFF0E6;
      --badge-delivery-text: #D4754E;

      --success-bg: #E8F5E9;
      --success-text: #2E7D32;
      --warning-bg: #FFF8E1;
      --warning-text: #F57F17;
      --error-bg: #FFEBEE;
      --error-text: #C62828;

      /* Bagel icon colors */
      --bagel-outer: #D4A574;
      --bagel-inner: #C49A6C;
      --bagel-hole: var(--bg-primary);
      --bagel-seeds: #8B5A2B;
    }

    [data-theme="dark"] {
      --bg-primary: #1A1816;
      --bg-secondary: #242220;
      --bg-tertiary: #2E2B28;
      --bg-input: #2E2B28;

      --text-primary: #F5F0EB;
      --text-secondary: #B8B0A5;
      --text-tertiary: #8A847A;
      --text-inverse: #1A1816;

      --border-light: #3D3935;
      --border-medium: #4A4540;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);

      --header-bg: linear-gradient(135deg, #3D3935 0%, #2E2B28 100%);
      --chat-bg: #1E1C1A;
      --user-bubble-bg: var(--brand-primary);
      --user-bubble-text: #FFFFFF;
      --assistant-bubble-bg: #2E2B28;
      --assistant-bubble-border: #3D3935;
      --assistant-bubble-text: var(--text-primary);

      --input-border: #4A4540;
      --input-focus-border: var(--brand-primary);
      --input-focus-shadow: 0 0 0 3px rgba(212, 117, 78, 0.25);

      --badge-bg: #3D3935;
      --badge-text: #E8A87C;
      --badge-delivery-bg: #3D3530;
      --badge-delivery-text: #E8A87C;

      --success-bg: #1B3D1E;
      --success-text: #81C784;
      --warning-bg: #3D3520;
      --warning-text: #FFD54F;
      --error-bg: #3D2020;
      --error-text: #EF9A9A;

      --bagel-outer: #C49A6C;
      --bagel-inner: #B08860;
      --bagel-hole: var(--bg-primary);
      --bagel-seeds: #D4A574;
    }

    /* =====================================================
       Base Styles
       ===================================================== */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* =====================================================
       Header
       ===================================================== */
    .app-header {
      background: var(--header-bg);
      color: var(--text-inverse);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
      position: relative;
      z-index: 50;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bagel-logo {
      width: 36px;
      height: 36px;
      transition: transform 0.3s ease;
    }

    .bagel-logo:hover {
      transform: rotate(15deg);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-subtitle {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.85;
    }

    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: inherit;
      font-size: 13px;
      font-weight: 500;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .theme-toggle .icon {
      font-size: 16px;
      transition: transform 0.3s ease;
    }

    [data-theme="dark"] .theme-toggle .icon {
      transform: rotate(180deg);
    }

    /* =====================================================
       Main Layout
       ===================================================== */
    .main-layout {
      display: flex;
      max-width: 1280px;
      margin: 24px auto;
      gap: 24px;
      padding: 0 24px;
      height: calc(100vh - 100px);
    }

    /* =====================================================
       Chat Container
       ===================================================== */
    .chat-container {
      flex: 1;
      background: var(--bg-secondary);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-light);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .main-layout .chat-container {
      max-width: none;
      margin: 0;
    }

    /* Caller ID Panel */
    .caller-id-panel {
      padding: 12px 20px;
      background: var(--warning-bg);
      border-bottom: 1px solid var(--border-light);
      font-size: 13px;
    }

    .caller-id-panel summary {
      cursor: pointer;
      color: var(--warning-text);
      font-weight: 600;
      user-select: none;
    }

    .caller-id-panel summary:hover {
      text-decoration: underline;
    }

    .caller-id-content {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .caller-id-content input,
    .caller-id-content select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .caller-id-content input:focus,
    .caller-id-content select:focus {
      outline: none;
      border-color: var(--input-focus-border);
      box-shadow: var(--input-focus-shadow);
    }

    .caller-id-content button {
      padding: 8px 16px;
      background: var(--brand-accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-inverse);
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .caller-id-content button:hover {
      background: #E09520;
    }

    .caller-id-content button:active {
      transform: scale(0.98);
    }

    .returning-customer-badge {
      background: var(--success-bg);
      color: var(--success-text);
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }

    /* TTS Controls */
    .tts-controls {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      font-size: 13px;
    }

    .tts-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .tts-controls select {
      padding: 6px 10px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      font-size: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      cursor: pointer;
    }

    .tts-mute-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--bg-input);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .tts-mute-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-medium);
    }

    .tts-mute-btn.muted {
      background: var(--error-bg);
      border-color: var(--error-text);
      color: var(--error-text);
    }

    .tts-mute-btn .icon {
      font-size: 16px;
    }

    .tts-status {
      margin-left: auto;
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .tts-status.speaking {
      color: var(--success-text);
    }

    .tts-status.error {
      color: var(--error-text);
    }

    /* Chat Header */
    .chat-header {
      padding: 12px 20px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }

    /* Chat Messages */
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: var(--chat-bg);
    }

    .msg-row {
      display: flex;
      margin-bottom: 12px;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-row.assistant {
      justify-content: flex-start;
    }

    .msg-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .msg-row.user .msg-bubble {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      border-bottom-right-radius: 6px;
    }

    .msg-row.assistant .msg-bubble {
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      border: 1px solid var(--assistant-bubble-border);
      border-bottom-left-radius: 6px;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 12px 16px;
    }

    .typing-indicator .dot {
      width: 8px;
      height: 8px;
      background: var(--text-tertiary);
      border-radius: 50%;
      animation: typing-bounce 1.4s infinite ease-in-out both;
    }

    .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-indicator .dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typing-bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Status Bar */
    .status-bar {
      font-size: 12px;
      color: var(--text-tertiary);
      padding: 6px 20px 10px;
      background: var(--chat-bg);
    }

    .mic-status {
      font-size: 11px;
      color: var(--text-tertiary);
      text-align: center;
      min-height: 18px;
      padding: 4px 0;
    }

    .mic-status.error {
      color: var(--error-text);
    }

    .mic-status.listening {
      color: var(--success-text);
    }

    /* Chat Footer / Input */
    .chat-footer {
      border-top: 1px solid var(--border-light);
      padding: 14px 16px;
      display: flex;
      gap: 10px;
      background: var(--bg-secondary);
    }

    .chat-footer input[type="text"] {
      flex: 1;
      border-radius: 24px;
      border: 2px solid var(--input-border);
      padding: 12px 18px;
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-input);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-footer input[type="text"]:focus {
      border-color: var(--input-focus-border);
      box-shadow: var(--input-focus-shadow);
    }

    .chat-footer input[type="text"]::placeholder {
      color: var(--text-tertiary);
    }

    .chat-footer button[type="submit"] {
      border-radius: 24px;
      border: none;
      background: var(--brand-primary);
      color: var(--text-inverse);
      padding: 0 24px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .chat-footer button[type="submit"]:hover {
      background: var(--brand-primary-hover);
    }

    .chat-footer button[type="submit"]:active {
      transform: scale(0.98);
    }

    .chat-footer button[type="submit"]:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Microphone Button */
    .mic-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--input-border);
      background: var(--bg-input);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .mic-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-medium);
    }

    .mic-btn.listening {
      background: var(--error-bg);
      border-color: var(--error-text);
      animation: pulse 1.5s infinite;
    }

    .mic-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    /* =====================================================
       Order Panel - Desktop
       ===================================================== */
    .order-panel {
      width: 340px;
      min-width: 300px;
      background: var(--bg-secondary);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-light);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .order-panel-header {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .order-panel-header .icon {
      font-size: 18px;
    }

    .order-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .order-panel-footer {
      padding: 20px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }

    /* Order Items */
    .order-item {
      padding: 14px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }

    .order-item-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .order-item-price {
      font-weight: 600;
      font-size: 14px;
      color: var(--brand-primary);
      white-space: nowrap;
    }

    .order-item-details {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 4px;
    }

    .order-item-note {
      margin-top: 6px;
      font-style: italic;
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .order-item-modifiers {
      margin-top: 6px;
      padding-left: 14px;
    }

    .order-item-modifier {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 3px 0;
    }

    .order-item-modifier-name {
      display: flex;
      align-items: center;
    }

    .order-item-modifier-name::before {
      content: "+";
      margin-right: 6px;
      color: var(--text-tertiary);
    }

    .order-item-modifier-price {
      color: var(--text-tertiary);
      white-space: nowrap;
    }

    /* Order Totals */
    .order-totals {
      font-size: 14px;
    }

    .order-total-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
    }

    .order-total-row.subtotal {
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }

    .order-total-row.total {
      font-weight: 700;
      font-size: 16px;
      padding-top: 10px;
      margin-top: 6px;
      border-top: 2px solid var(--text-primary);
      color: var(--text-primary);
    }

    .order-total-label {
      color: var(--text-secondary);
    }

    .order-total-row.total .order-total-label {
      color: var(--text-primary);
    }

    .order-total-row.total span:last-child {
      color: var(--brand-primary);
    }

    /* Order Type Badge */
    .order-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--badge-bg);
      color: var(--badge-text);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .order-type-badge.delivery {
      background: var(--badge-delivery-bg);
      color: var(--badge-delivery-text);
    }

    .order-type-badge .icon {
      font-size: 16px;
    }

    /* Empty State */
    .order-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }

    .order-empty .icon {
      font-size: 52px;
      margin-bottom: 14px;
      opacity: 0.6;
    }

    .order-empty p {
      margin: 0;
      font-size: 14px;
    }

    /* Order Status */
    .order-status {
      text-align: center;
      padding: 14px;
      margin-top: 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .order-status.confirmed {
      background: var(--success-bg);
      color: var(--success-text);
    }

    .order-status.pending {
      background: var(--warning-bg);
      color: var(--warning-text);
    }

    /* Customer Info */
    .order-customer {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border-light);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .order-customer-row {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    .order-customer-row .icon {
      width: 18px;
      text-align: center;
    }

    /* =====================================================
       Mobile Styles
       ===================================================== */
    .order-panel-mobile {
      display: none;
    }

    .order-panel-collapsed {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-light);
      padding: 14px 20px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
      z-index: 100;
      cursor: pointer;
    }

    .order-panel-collapsed-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-panel-collapsed-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .order-panel-collapsed-icon {
      font-size: 22px;
    }

    .order-panel-collapsed-text {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .order-panel-collapsed-total {
      font-weight: 700;
      font-size: 17px;
      color: var(--brand-primary);
    }

    .order-panel-collapsed-chevron {
      font-size: 18px;
      color: var(--text-tertiary);
    }

    /* Mobile Expanded Panel */
    .order-panel-expanded {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 75vh;
      background: var(--bg-secondary);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -8px 32px rgba(0,0,0,0.2);
      z-index: 101;
      flex-direction: column;
      overflow: hidden;
    }

    .order-panel-expanded.active {
      display: flex;
    }

    .order-panel-expanded-header {
      padding: 18px 20px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: var(--bg-tertiary);
    }

    .order-panel-expanded-header h3 {
      margin: 0;
      font-size: 17px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .order-panel-expanded-close {
      font-size: 22px;
      color: var(--text-tertiary);
    }

    .order-panel-expanded-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .order-panel-expanded-footer {
      padding: 20px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }

    .order-panel-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
    }

    .order-panel-overlay.active {
      display: block;
    }

    /* =====================================================
       Responsive
       ===================================================== */
    @media (max-width: 960px) {
      .main-layout {
        flex-direction: column;
        padding: 0;
        margin: 0;
        height: calc(100vh - 60px);
        gap: 0;
      }

      .main-layout .chat-container {
        border-radius: 0;
        height: calc(100vh - 60px - 65px);
        border-left: none;
        border-right: none;
      }

      .order-panel {
        display: none;
      }

      .order-panel-mobile {
        display: block;
      }

      .order-panel-collapsed {
        display: block;
      }

      .header-subtitle {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .app-header {
        padding: 10px 16px;
      }

      .bagel-logo {
        width: 32px;
        height: 32px;
      }

      .theme-toggle span:not(.icon) {
        display: none;
      }

      .theme-toggle {
        padding: 8px;
        border-radius: 50%;
      }

      .chat-footer {
        padding: 12px;
      }

      .chat-footer button[type="submit"] {
        padding: 0 18px;
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <div class="header-left">
      <!-- Zucker's Bagel Logo SVG -->
      <svg class="bagel-logo" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer bagel ring -->
        <circle cx="24" cy="24" r="20" fill="var(--bagel-outer)" />
        <!-- Inner shadow/depth -->
        <circle cx="24" cy="24" r="16" fill="var(--bagel-inner)" />
        <!-- Center hole -->
        <circle cx="24" cy="24" r="8" fill="var(--bagel-hole)" />
        <!-- Everything bagel seeds -->
        <circle cx="14" cy="12" r="1.5" fill="var(--bagel-seeds)" />
        <circle cx="19" cy="9" r="1.2" fill="var(--bagel-seeds)" />
        <circle cx="29" cy="10" r="1.4" fill="var(--bagel-seeds)" />
        <circle cx="34" cy="14" r="1.3" fill="var(--bagel-seeds)" />
        <circle cx="37" cy="22" r="1.5" fill="var(--bagel-seeds)" />
        <circle cx="36" cy="30" r="1.2" fill="var(--bagel-seeds)" />
        <circle cx="32" cy="36" r="1.4" fill="var(--bagel-seeds)" />
        <circle cx="24" cy="39" r="1.3" fill="var(--bagel-seeds)" />
        <circle cx="16" cy="37" r="1.5" fill="var(--bagel-seeds)" />
        <circle cx="11" cy="30" r="1.2" fill="var(--bagel-seeds)" />
        <circle cx="10" cy="21" r="1.4" fill="var(--bagel-seeds)" />
        <!-- Additional seeds for fullness -->
        <ellipse cx="22" cy="7" rx="1" ry="1.3" fill="var(--bagel-seeds)" opacity="0.8" />
        <ellipse cx="38" cy="26" rx="1.2" ry="1" fill="var(--bagel-seeds)" opacity="0.8" />
        <ellipse cx="28" cy="38" rx="1" ry="1.2" fill="var(--bagel-seeds)" opacity="0.8" />
        <ellipse cx="8" cy="26" rx="1.2" ry="1" fill="var(--bagel-seeds)" opacity="0.8" />
      </svg>
    </div>
    <div class="header-right">
      <span class="header-subtitle">Demo Web Chat</span>
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark/light mode">
        <span class="icon">‚òÄÔ∏è</span>
        <span>Light</span>
      </button>
    </div>
  </div>

  <div class="main-layout">
    <div class="chat-container">
      <!-- Caller ID Simulation Panel -->
      <details class="caller-id-panel" id="caller-id-panel">
        <summary>Simulate Incoming Call (Dev Mode)</summary>
        <div class="caller-id-content">
          <label for="store-select" style="white-space: nowrap; font-weight: 500;">Store:</label>
          <select id="store-select"></select>
        </div>
        <div class="caller-id-content" style="margin-top: 10px;">
          <input
            type="tel"
            id="caller-id-input"
            placeholder="Enter phone number (e.g., 555-123-4567)"
          />
          <button type="button" id="start-with-caller-id">Start Call</button>
        </div>
        <div style="margin-top: 8px; color: var(--text-tertiary); font-size: 12px;">
          Select a store and optionally enter a phone number.
        </div>
      </details>

      <!-- TTS Voice Controls -->
      <div class="tts-controls" id="tts-controls">
        <label>
          <span class="icon">üîä</span>
          Voice:
          <select id="tts-voice-select">
            <option value="">Loading voices...</option>
          </select>
        </label>
        <button type="button" class="tts-mute-btn" id="tts-mute-btn" title="Toggle voice on/off">
          <span class="icon">üîä</span>
          <span class="label">Voice On</span>
        </button>
        <span class="tts-status" id="tts-status"></span>
      </div>

      <div class="chat-header" id="chat-header">Connecting...</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="status-bar" id="status-bar">Disconnected</div>
      <div class="mic-status" id="mic-status"></div>
      <form class="chat-footer" id="chat-form">
        <input
          type="text"
          id="chat-input"
          autocomplete="off"
          placeholder="Type your message..."
        />
        <button type="button" class="mic-btn" id="mic-btn" title="Voice input">üé§</button>
        <button type="submit">Send</button>
      </form>
    </div>

    <!-- Order Panel - Desktop -->
    <div class="order-panel" id="order-panel">
      <div class="order-panel-header">
        <span class="icon">üõí</span>
        Your Order
      </div>
      <div class="order-panel-body" id="order-panel-body">
        <div class="order-empty" id="order-empty">
          <div class="icon">ü•Ø</div>
          <p>Your cart is empty</p>
          <p style="font-size: 12px; margin-top: 10px; color: var(--text-tertiary);">Items will appear here as you order</p>
        </div>
        <div id="order-items-container" style="display: none;">
          <div class="order-type-badge" id="order-type-badge" style="display: none;">
            <span class="icon">üè™</span>
            <span id="order-type-text">Pickup</span>
          </div>
          <div id="order-items-list"></div>
        </div>
      </div>
      <div class="order-panel-footer" id="order-panel-footer" style="display: none;">
        <div class="order-totals">
          <div class="order-total-row subtotal">
            <span class="order-total-label">Subtotal</span>
            <span id="order-subtotal">$0.00</span>
          </div>
          <div class="order-total-row" id="order-city-tax-row" style="display: none;">
            <span class="order-total-label">City Tax</span>
            <span id="order-city-tax">$0.00</span>
          </div>
          <div class="order-total-row" id="order-state-tax-row" style="display: none;">
            <span class="order-total-label">State Tax</span>
            <span id="order-state-tax">$0.00</span>
          </div>
          <div class="order-total-row" id="order-delivery-row" style="display: none;">
            <span class="order-total-label">Delivery Fee</span>
            <span id="order-delivery-fee">$0.00</span>
          </div>
          <div class="order-total-row total">
            <span class="order-total-label">Total</span>
            <span id="order-total">$0.00</span>
          </div>
        </div>
        <div class="order-status" id="order-status-badge" style="display: none;">Order Confirmed!</div>
        <div class="order-customer" id="order-customer" style="display: none;">
          <div class="order-customer-row" id="customer-name-row">
            <span class="icon">üë§</span>
            <span id="customer-name"></span>
          </div>
          <div class="order-customer-row" id="customer-phone-row" style="display: none;">
            <span class="icon">üìû</span>
            <span id="customer-phone"></span>
          </div>
          <div class="order-customer-row" id="customer-address-row" style="display: none;">
            <span class="icon">üìç</span>
            <span id="customer-address"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Order Panel -->
  <div class="order-panel-mobile" id="order-panel-mobile">
    <div class="order-panel-overlay" id="order-panel-overlay"></div>
    <div class="order-panel-collapsed" id="order-panel-collapsed">
      <div class="order-panel-collapsed-content">
        <div class="order-panel-collapsed-left">
          <span class="order-panel-collapsed-icon">ü•Ø</span>
          <span class="order-panel-collapsed-text" id="mobile-cart-summary">Cart empty</span>
        </div>
        <div class="order-panel-collapsed-total" id="mobile-cart-total">$0.00</div>
        <span class="order-panel-collapsed-chevron">‚ñ≤</span>
      </div>
    </div>
    <div class="order-panel-expanded" id="order-panel-expanded">
      <div class="order-panel-expanded-header" id="order-panel-expanded-header">
        <h3><span class="icon">ü•Ø</span> Your Order</h3>
        <span class="order-panel-expanded-close">‚úï</span>
      </div>
      <div class="order-panel-expanded-body" id="order-panel-expanded-body"></div>
      <div class="order-panel-expanded-footer" id="order-panel-expanded-footer"></div>
    </div>
  </div>

  <script>
    // =====================================================
    // Theme Toggle
    // =====================================================
    const themeToggle = document.getElementById('theme-toggle');
    const html = document.documentElement;

    // Load saved theme or default to light
    const savedTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    updateThemeButton(savedTheme);

    function updateThemeButton(theme) {
      const icon = themeToggle.querySelector('.icon');
      const text = themeToggle.querySelector('span:not(.icon)');
      if (theme === 'dark') {
        icon.textContent = 'üåô';
        text.textContent = 'Dark';
      } else {
        icon.textContent = '‚òÄÔ∏è';
        text.textContent = 'Light';
      }
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeButton(newTheme);
    });

    // =====================================================
    // Core Chat Elements
    // =====================================================
    const messagesEl = document.getElementById("chat-messages");
    const headerEl = document.getElementById("chat-header");
    const statusEl = document.getElementById("status-bar");
    const formEl = document.getElementById("chat-form");
    const inputEl = document.getElementById("chat-input");
    const callerIdPanel = document.getElementById("caller-id-panel");
    const callerIdInput = document.getElementById("caller-id-input");
    const storeSelect = document.getElementById("store-select");
    const startWithCallerIdBtn = document.getElementById("start-with-caller-id");

    let STORE_NAMES = {};
    const USE_STREAMING = true;

    let companyInfo = {
      name: "Zucker's Bagels",
      bot_persona_name: "Zack",
      primary_item_type: "Bagel"
    };

    async function loadCompanyInfo() {
      try {
        const response = await fetch("/company");
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        companyInfo = await response.json();
        console.log("[Company] Loaded:", companyInfo.name);
        document.title = `${companyInfo.name} - Order Bot`;
        return companyInfo;
      } catch (error) {
        console.error("[Company] Failed to load:", error);
        return companyInfo;
      }
    }

    async function loadStoresAndPopulateDropdown() {
      let stores = [];
      try {
        const response = await fetch("/stores");
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        stores = await response.json();
        console.log("[Stores] Loaded:", stores.length);
      } catch (error) {
        console.error("[Stores] Failed to load:", error);
        stores = [];
      }

      const availableStores = stores.map(s => ({ id: s.store_id, name: s.name }));
      STORE_NAMES = {};
      availableStores.forEach(store => {
        const shortName = store.name.includes(" - ") ? store.name.split(" - ").pop() : store.name;
        STORE_NAMES[store.id] = shortName;
      });

      storeSelect.innerHTML = "";
      if (availableStores.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No stores available";
        storeSelect.appendChild(opt);
      } else {
        availableStores.forEach(store => {
          const opt = document.createElement("option");
          opt.value = store.id;
          opt.textContent = STORE_NAMES[store.id];
          storeSelect.appendChild(opt);
        });
      }
      return availableStores;
    }

    let sessionId = null;
    let connected = false;
    let currentCallerId = null;
    let currentStoreId = null;
    let typingIndicatorEl = null;

    // Analytics
    let sessionStartTime = null;
    let messageCount = 0;
    let orderState = { status: "pending", items: [], total_price: 0 };
    let lastBotMessage = null;
    let lastUserMessage = null;
    let orderConfirmed = false;
    let conversationHistory = [];

    function addMessage(role, text) {
      const row = document.createElement("div");
      row.className = "msg-row " + role;
      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showTypingIndicator() {
      if (typingIndicatorEl) return;
      const row = document.createElement("div");
      row.className = "msg-row assistant";
      const bubble = document.createElement("div");
      bubble.className = "msg-bubble typing-indicator";
      bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      typingIndicatorEl = row;
    }

    function hideTypingIndicator() {
      if (typingIndicatorEl) {
        typingIndicatorEl.remove();
        typingIndicatorEl = null;
      }
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function startSession(callerId = null, storeId = null) {
      try {
        setStatus("Starting session...");
        let url = "/chat/start";
        const params = new URLSearchParams();
        if (callerId) {
          params.append("caller_id", callerId);
          currentCallerId = callerId;
        }
        if (storeId) {
          params.append("store_id", storeId);
          currentStoreId = storeId;
        }
        if (params.toString()) url += "?" + params.toString();

        const resp = await fetch(url, { method: "POST" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        sessionId = data.session_id;
        connected = true;
        sessionStartTime = Date.now();

        let headerText = "Session: " + sessionId.substring(0, 8);
        if (storeId && STORE_NAMES[storeId]) headerText += ` | ${STORE_NAMES[storeId]}`;
        if (callerId) headerText += ` | ${callerId}`;
        if (data.returning_customer && data.returning_customer.name) {
          headerText += ` | ${data.returning_customer.name}`;
          headerEl.innerHTML = headerText + '<span class="returning-customer-badge">Returning</span>';
        } else {
          headerEl.textContent = headerText;
        }

        setStatus("Connected");
        callerIdPanel.removeAttribute("open");

        if (data.message) {
          addMessage("assistant", data.message);
          lastBotMessage = data.message;
          messageCount++;
          conversationHistory.push({ role: "assistant", content: data.message });
        }
        if (data.returning_customer) console.log("Returning customer:", data.returning_customer);
      } catch (err) {
        console.error("Error starting session:", err);
        headerEl.textContent = "Error starting session";
        setStatus("Failed to connect");
      }
    }

    async function sendMessage(text) {
      if (!sessionId) return;
      addMessage("user", text);
      lastUserMessage = text;
      messageCount++;
      conversationHistory.push({ role: "user", content: text });
      setStatus("Sending...");
      showTypingIndicator();
      if (USE_STREAMING) await sendMessageStreaming(text);
      else await sendMessageNonStreaming(text);
    }

    async function sendMessageNonStreaming(text) {
      try {
        const resp = await fetch("/chat/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId, message: text }),
        });
        hideTypingIndicator();
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (data.reply) {
          addMessage("assistant", data.reply);
          lastBotMessage = data.reply;
          messageCount++;
          conversationHistory.push({ role: "assistant", content: data.reply });
        }
        if (data.order_state) {
          orderState = data.order_state;
          if (orderState.status === "confirmed") orderConfirmed = true;
        }
        setStatus("Connected");
      } catch (err) {
        hideTypingIndicator();
        console.error("Error:", err);
        addMessage("assistant", "Oops, something went wrong.");
        setStatus("Error");
      }
    }

    async function sendMessageStreaming(text) {
      let streamingMessageEl = null;
      let fullReply = "";
      try {
        const resp = await fetch("/chat/message/stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId, message: text }),
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        hideTypingIndicator();
        setStatus("Receiving...");

        streamingMessageEl = document.createElement("div");
        streamingMessageEl.className = "msg-row assistant";
        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        streamingMessageEl.appendChild(bubble);
        messagesEl.appendChild(streamingMessageEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split("\n");
          for (const line of lines) {
            if (line.startsWith("data: ")) {
              const jsonStr = line.slice(6);
              if (!jsonStr) continue;
              try {
                const event = JSON.parse(jsonStr);
                if (event.done) {
                  fullReply = event.reply || "";
                  bubble.textContent = fullReply;
                  if (fullReply) {
                    lastBotMessage = fullReply;
                    messageCount++;
                    conversationHistory.push({ role: "assistant", content: fullReply });
                    if (typeof speakText === "function") speakText(fullReply);
                  }
                  if (event.order_state) {
                    orderState = event.order_state;
                    if (orderState.status === "confirmed") orderConfirmed = true;
                  }
                  setStatus("Connected");
                }
                if (event.error) {
                  bubble.textContent = event.error;
                  setStatus("Error");
                }
              } catch (e) {
                console.error("Parse error:", e);
              }
            }
          }
        }
      } catch (err) {
        hideTypingIndicator();
        console.error("Error:", err);
        if (streamingMessageEl) {
          streamingMessageEl.querySelector('.msg-bubble').textContent = "Oops, something went wrong.";
        } else {
          addMessage("assistant", "Oops, something went wrong.");
        }
        setStatus("Error");
      }
    }

    formEl.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = "";
      sendMessage(text);
    });

    startWithCallerIdBtn.addEventListener("click", () => {
      const callerId = callerIdInput.value.trim();
      const storeId = storeSelect.value;
      if (sessionId) {
        sessionId = null;
        connected = false;
        messagesEl.innerHTML = "";
        messageCount = 0;
        orderState = { status: "pending", items: [], total_price: 0 };
        lastBotMessage = null;
        lastUserMessage = null;
        orderConfirmed = false;
        conversationHistory = [];
        abandonAnalyticsSent = false;
      }
      startSession(callerId || null, storeId);
    });

    window.addEventListener("load", async () => {
      await loadCompanyInfo();
      await loadTTSVoices();
      const availableStores = await loadStoresAndPopulateDropdown();
      const urlParams = new URLSearchParams(window.location.search);
      const storeIdParam = urlParams.get("store") || urlParams.get("store_id");
      const callerIdParam = urlParams.get("caller_id");
      if (storeIdParam && STORE_NAMES[storeIdParam]) storeSelect.value = storeIdParam;
      if (callerIdParam) callerIdInput.value = callerIdParam;
      const storeId = storeIdParam && STORE_NAMES[storeIdParam] ? storeIdParam : storeSelect.value;
      if (storeId) startSession(callerIdParam || null, storeId);
      else {
        headerEl.textContent = "No stores available";
        setStatus("Please add stores");
      }
    });

    // Abandon analytics
    let abandonAnalyticsSent = false;
    function sendAbandonAnalytics(reason) {
      if (abandonAnalyticsSent || !sessionId || orderConfirmed) return;
      abandonAnalyticsSent = true;
      const items = orderState.items || [];
      const sessionDuration = sessionStartTime ? Math.floor((Date.now() - sessionStartTime) / 1000) : null;
      const payload = {
        session_id: sessionId,
        message_count: messageCount,
        had_items_in_cart: items.length > 0,
        item_count: items.length,
        cart_total: orderState.total_price || 0,
        order_status: orderState.status || "pending",
        last_bot_message: lastBotMessage,
        last_user_message: lastUserMessage,
        reason: reason,
        session_duration_seconds: sessionDuration,
        conversation_history: conversationHistory,
        store_id: currentStoreId,
      };
      const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
      navigator.sendBeacon("/chat/abandon", blob);
    }
    window.addEventListener("beforeunload", () => sendAbandonAnalytics("browser_close"));

    // =====================================================
    // TTS
    // =====================================================
    const ttsVoiceSelect = document.getElementById("tts-voice-select");
    const ttsMuteBtn = document.getElementById("tts-mute-btn");
    const ttsStatus = document.getElementById("tts-status");

    let ttsVoices = [];
    let ttsMuted = localStorage.getItem("tts_muted") === "true";
    let ttsSelectedVoice = localStorage.getItem("tts_voice") || null;
    let ttsAudio = null;
    let ttsQueue = [];
    let ttsSpeaking = false;
    let ttsReady = false;

    function updateMuteButtonUI() {
      if (ttsMuted) {
        ttsMuteBtn.classList.add("muted");
        ttsMuteBtn.querySelector(".icon").textContent = "üîá";
        ttsMuteBtn.querySelector(".label").textContent = "Voice Off";
      } else {
        ttsMuteBtn.classList.remove("muted");
        ttsMuteBtn.querySelector(".icon").textContent = "üîä";
        ttsMuteBtn.querySelector(".label").textContent = "Voice On";
      }
    }

    async function loadTTSVoices() {
      try {
        const response = await fetch("/tts/voices");
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        ttsVoices = data.voices || [];
        ttsVoiceSelect.innerHTML = "";
        ttsVoices.forEach(voice => {
          const opt = document.createElement("option");
          opt.value = voice.id;
          let label = voice.name;
          if (voice.gender || voice.accent) {
            label += ` (${[voice.gender, voice.accent].filter(Boolean).join(", ")})`;
          }
          opt.textContent = label;
          ttsVoiceSelect.appendChild(opt);
        });
        if (ttsSelectedVoice && ttsVoices.some(v => v.id === ttsSelectedVoice)) {
          ttsVoiceSelect.value = ttsSelectedVoice;
        } else if (ttsVoices.length > 0) {
          const defaultVoice = ttsVoices.find(v => v.id === "nova") || ttsVoices[0];
          ttsVoiceSelect.value = defaultVoice.id;
          ttsSelectedVoice = defaultVoice.id;
        }
        ttsReady = true;
      } catch (error) {
        console.error("[TTS] Failed:", error);
        ttsVoiceSelect.innerHTML = '<option value="">Unavailable</option>';
        setTTSStatus("Unavailable", "error");
        ttsReady = false;
      }
    }

    function setTTSStatus(message, type = "") {
      ttsStatus.textContent = message;
      ttsStatus.className = "tts-status" + (type ? ` ${type}` : "");
      if (type !== "error" && message) {
        setTimeout(() => {
          if (ttsStatus.textContent === message) {
            ttsStatus.textContent = "";
            ttsStatus.className = "tts-status";
          }
        }, 3000);
      }
    }

    async function speakText(text) {
      if (ttsMuted || !text || !ttsReady || !ttsSelectedVoice) return;
      ttsQueue.push(text);
      if (ttsSpeaking) return;
      await processQueue();
    }

    async function processQueue() {
      if (ttsQueue.length === 0) {
        ttsSpeaking = false;
        return;
      }
      ttsSpeaking = true;
      const text = ttsQueue.shift();
      try {
        setTTSStatus("Speaking...", "speaking");
        if (ttsAudio) {
          ttsAudio.pause();
          ttsAudio = null;
        }
        const response = await fetch("/tts/synthesize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice: ttsSelectedVoice, speed: 1.0 })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        ttsAudio = new Audio(audioUrl);
        ttsAudio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          setTTSStatus("");
          processQueue();
        };
        ttsAudio.onerror = () => {
          URL.revokeObjectURL(audioUrl);
          setTTSStatus("Playback error", "error");
          processQueue();
        };
        if (ttsMuted) {
          ttsAudio = null;
          setTTSStatus("");
          processQueue();
          return;
        }
        try {
          await ttsAudio.play();
        } catch (playError) {
          if (playError.name === 'NotAllowedError') {
            setTTSStatus("Click to enable", "error");
            URL.revokeObjectURL(audioUrl);
            ttsAudio = null;
            processQueue();
            return;
          }
          throw playError;
        }
      } catch (error) {
        console.error("[TTS] Error:", error);
        setTTSStatus("Error", "error");
        setTimeout(() => {
          if (ttsStatus.textContent === "Error") {
            ttsStatus.textContent = "";
            ttsStatus.className = "tts-status";
          }
        }, 5000);
        processQueue();
      }
    }

    function stopSpeaking() {
      ttsQueue = [];
      if (ttsAudio) {
        ttsAudio.pause();
        ttsAudio = null;
      }
      ttsSpeaking = false;
      setTTSStatus("");
    }

    ttsVoiceSelect.addEventListener("change", () => {
      ttsSelectedVoice = ttsVoiceSelect.value;
      localStorage.setItem("tts_voice", ttsSelectedVoice);
    });

    ttsMuteBtn.addEventListener("click", () => {
      ttsMuted = !ttsMuted;
      localStorage.setItem("tts_muted", ttsMuted);
      updateMuteButtonUI();
      if (ttsMuted) stopSpeaking();
    });

    updateMuteButtonUI();

    let audioEnabled = false;
    let pendingGreeting = null;
    async function enableAudioAndPlayGreeting() {
      if (!audioEnabled) {
        audioEnabled = true;
        if (ttsStatus.textContent === "Click to enable") {
          ttsStatus.textContent = "";
          ttsStatus.className = "tts-status";
        }
        if (pendingGreeting && !ttsMuted) {
          await speakText(pendingGreeting);
          pendingGreeting = null;
        }
      }
    }
    document.addEventListener("click", enableAudioAndPlayGreeting, { once: true });
    document.addEventListener("keydown", enableAudioAndPlayGreeting, { once: true });

    const originalAddMessage = addMessage;
    addMessage = function(role, text) {
      originalAddMessage(role, text);
      if (role === "assistant" && text) speakText(text);
    };

    // =====================================================
    // Speech Recognition
    // =====================================================
    const micBtn = document.getElementById("mic-btn");
    const micStatus = document.getElementById("mic-status");
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;

    function setMicStatus(message, type = "") {
      micStatus.textContent = message;
      micStatus.className = "mic-status" + (type ? ` ${type}` : "");
      if (type !== "error" && message) {
        setTimeout(() => {
          if (micStatus.textContent === message) {
            micStatus.textContent = "";
            micStatus.className = "mic-status";
          }
        }, 3000);
      }
    }

    if (!SpeechRecognition) {
      micBtn.disabled = true;
      micBtn.title = "Not supported";
      setMicStatus("Voice input not supported", "error");
    } else {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = "en-US";
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        isListening = true;
        micBtn.classList.add("listening");
        micBtn.textContent = "üî¥";
        setMicStatus("Listening...", "listening");
        if (typeof stopSpeaking === "function") stopSpeaking();
      };

      recognition.onresult = (event) => {
        let finalTranscript = "";
        let interimTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) finalTranscript += transcript;
          else interimTranscript += transcript;
        }
        if (interimTranscript) {
          inputEl.value = interimTranscript;
          setMicStatus("Listening...", "listening");
        }
        if (finalTranscript) inputEl.value = finalTranscript;
      };

      recognition.onend = () => {
        isListening = false;
        micBtn.classList.remove("listening");
        micBtn.textContent = "üé§";
        const text = inputEl.value.trim();
        if (text) {
          setMicStatus("Sending...", "");
          setTimeout(() => {
            inputEl.value = "";
            sendMessage(text);
            setMicStatus("");
          }, 300);
        } else {
          setMicStatus("No speech detected", "");
        }
      };

      recognition.onerror = (event) => {
        isListening = false;
        micBtn.classList.remove("listening");
        micBtn.textContent = "üé§";
        let errorMessage = "Voice error";
        switch (event.error) {
          case "no-speech": errorMessage = "No speech detected"; break;
          case "audio-capture": errorMessage = "No microphone"; break;
          case "not-allowed": errorMessage = "Mic access denied"; break;
          case "network": errorMessage = "Network error"; break;
          case "aborted": errorMessage = ""; break;
        }
        if (errorMessage) setMicStatus(errorMessage, "error");
      };

      micBtn.addEventListener("click", () => {
        if (!connected || !sessionId) {
          setMicStatus("Start session first", "error");
          return;
        }
        if (isListening) {
          recognition.stop();
          setMicStatus("Stopped", "");
        } else {
          try {
            inputEl.value = "";
            recognition.start();
          } catch (err) {
            setMicStatus("Failed to start", "error");
          }
        }
      });
    }

    // =====================================================
    // Order Panel
    // =====================================================
    const orderPanelBody = document.getElementById("order-panel-body");
    const orderEmpty = document.getElementById("order-empty");
    const orderItemsContainer = document.getElementById("order-items-container");
    const orderItemsList = document.getElementById("order-items-list");
    const orderTypeBadge = document.getElementById("order-type-badge");
    const orderTypeText = document.getElementById("order-type-text");
    const orderPanelFooter = document.getElementById("order-panel-footer");
    const orderSubtotal = document.getElementById("order-subtotal");
    const orderCityTax = document.getElementById("order-city-tax");
    const orderCityTaxRow = document.getElementById("order-city-tax-row");
    const orderStateTax = document.getElementById("order-state-tax");
    const orderStateTaxRow = document.getElementById("order-state-tax-row");
    const orderDeliveryFee = document.getElementById("order-delivery-fee");
    const orderDeliveryRow = document.getElementById("order-delivery-row");
    const orderTotalEl = document.getElementById("order-total");
    const orderStatusBadge = document.getElementById("order-status-badge");
    const orderCustomer = document.getElementById("order-customer");
    const customerNameEl = document.getElementById("customer-name");
    const customerPhoneEl = document.getElementById("customer-phone");
    const customerPhoneRow = document.getElementById("customer-phone-row");
    const customerAddressEl = document.getElementById("customer-address");
    const customerAddressRow = document.getElementById("customer-address-row");

    const orderPanelCollapsed = document.getElementById("order-panel-collapsed");
    const orderPanelExpanded = document.getElementById("order-panel-expanded");
    const orderPanelOverlay = document.getElementById("order-panel-overlay");
    const orderPanelExpandedBody = document.getElementById("order-panel-expanded-body");
    const orderPanelExpandedFooter = document.getElementById("order-panel-expanded-footer");
    const mobileCartSummary = document.getElementById("mobile-cart-summary");
    const mobileCartTotal = document.getElementById("mobile-cart-total");

    let mobileExpanded = false;

    function formatCurrency(amount) {
      return "$" + (amount || 0).toFixed(2);
    }

    function renderOrderItem(item) {
      const div = document.createElement("div");
      div.className = "order-item";
      const qty = item.quantity || 1;
      const name = item.display_name || item.menu_item_name || item.name || "Item";
      const hasModifiers = item.modifiers && item.modifiers.length > 0;

      let html = "";
      // Show itemized modifiers for bagels, speed menu bagels, menu items, and drinks with upcharges
      if (hasModifiers && (item.item_type === "bagel" || item.item_type === "speed_menu_bagel" || item.item_type === "menu_item" || item.item_type === "drink")) {
        const basePrice = item.base_price || (item.unit_price - item.modifiers.reduce((sum, m) => sum + (m.price || 0), 0));
        html += `<div class="order-item-header"><span class="order-item-name">${qty > 1 ? qty + "x " : ""}${name}</span><span class="order-item-price">${formatCurrency(basePrice)}</span></div>`;

        // For drinks, show free details first (hot/iced, sweetener, etc.)
        if (item.item_type === "drink" && item.free_details && item.free_details.length > 0) {
          html += `<div class="order-item-details">${item.free_details.join(" ¬∑ ")}</div>`;
        }

        // Show itemized modifiers with prices
        html += `<div class="order-item-modifiers">`;
        for (const mod of item.modifiers) {
          const priceHtml = mod.price > 0 ? formatCurrency(mod.price) : '';
          html += `<div class="order-item-modifier"><span class="order-item-modifier-name">${mod.name}</span><span class="order-item-modifier-price">${priceHtml}</span></div>`;
        }
        html += `</div>`;
      } else {
        const price = item.line_total || item.price || 0;
        html += `<div class="order-item-header"><span class="order-item-name">${qty > 1 ? qty + "x " : ""}${name}</span><span class="order-item-price">${formatCurrency(price)}</span></div>`;
        const details = [];
        if (item.bread) details.push(item.bread);
        if (item.protein) details.push(item.protein);
        if (item.cheese) details.push(item.cheese);
        const config = item.item_config || {};
        if (config.style) details.push(config.style);
        if (item.size || config.size) details.push(item.size || config.size);
        if (config.milk && !["none", "black"].includes(config.milk.toLowerCase())) details.push(config.milk + " milk");
        else if (config.milk && ["none", "black"].includes(config.milk.toLowerCase())) details.push("black");
        else if (item.milk) details.push(item.milk + " milk");
        if (config.flavor_syrup) details.push(config.flavor_syrup + " syrup");
        if (config.sweetener) {
          const sq = config.sweetener_quantity || 1;
          details.push(sq > 1 ? `${sq} ${config.sweetener}s` : config.sweetener);
        }
        if (config.decaf) details.push("decaf");
        if (item.toppings && item.toppings.length > 0) details.push(item.toppings.join(", "));
        if (item.sauces && item.sauces.length > 0) details.push(item.sauces.join(", "));
        if (item.toasted) details.push("Toasted");
        if (item.spread) details.push(item.spread);
        if (details.length > 0) html += `<div class="order-item-details">${details.join(" ¬∑ ")}</div>`;
      }
      if (item.notes || item.special_instructions) {
        html += `<div class="order-item-note">"${item.notes || item.special_instructions}"</div>`;
      }
      div.innerHTML = html;
      return div;
    }

    function renderOrderPanel(state) {
      if (!state) return;
      const items = state.items || [];
      const hasItems = items.length > 0;

      orderEmpty.style.display = hasItems ? "none" : "block";
      orderItemsContainer.style.display = hasItems ? "block" : "none";
      orderPanelFooter.style.display = hasItems ? "block" : "none";

      if (!hasItems) {
        mobileCartSummary.textContent = "Cart empty";
        mobileCartTotal.textContent = "$0.00";
        return;
      }

      orderItemsList.innerHTML = "";
      items.forEach(item => orderItemsList.appendChild(renderOrderItem(item)));

      const orderType = state.order_type;
      if (orderType) {
        orderTypeBadge.style.display = "inline-flex";
        if (orderType === "delivery") {
          orderTypeBadge.classList.add("delivery");
          orderTypeBadge.querySelector(".icon").textContent = "üöó";
          orderTypeText.textContent = "Delivery";
        } else {
          orderTypeBadge.classList.remove("delivery");
          orderTypeBadge.querySelector(".icon").textContent = "üè™";
          orderTypeText.textContent = "Pickup";
        }
      } else {
        orderTypeBadge.style.display = "none";
      }

      const checkout = state.checkout_state || {};
      const subtotal = checkout.subtotal || state.total_price || items.reduce((sum, i) => sum + (i.line_total || i.price || 0), 0);
      const cityTax = checkout.city_tax || 0;
      const stateTax = checkout.state_tax || 0;
      const deliveryFee = checkout.delivery_fee || 0;
      const total = checkout.total || (subtotal + cityTax + stateTax + deliveryFee);

      orderSubtotal.textContent = formatCurrency(subtotal);
      orderCityTaxRow.style.display = cityTax > 0 ? "flex" : "none";
      orderCityTax.textContent = formatCurrency(cityTax);
      orderStateTaxRow.style.display = stateTax > 0 ? "flex" : "none";
      orderStateTax.textContent = formatCurrency(stateTax);
      orderDeliveryRow.style.display = deliveryFee > 0 ? "flex" : "none";
      orderDeliveryFee.textContent = formatCurrency(deliveryFee);
      orderTotalEl.textContent = formatCurrency(total);

      if (state.status === "confirmed") {
        orderStatusBadge.style.display = "block";
        orderStatusBadge.className = "order-status confirmed";
        orderStatusBadge.textContent = "‚úì Order Confirmed!";
      } else {
        orderStatusBadge.style.display = "none";
      }

      const customer = state.customer || {};
      if (customer.name || customer.phone || state.delivery_address) {
        orderCustomer.style.display = "block";
        document.getElementById("customer-name-row").style.display = customer.name ? "flex" : "none";
        customerNameEl.textContent = customer.name || "";
        customerPhoneRow.style.display = customer.phone ? "flex" : "none";
        customerPhoneEl.textContent = customer.phone || "";
        customerAddressRow.style.display = state.delivery_address ? "flex" : "none";
        customerAddressEl.textContent = state.delivery_address || "";
      } else {
        orderCustomer.style.display = "none";
      }

      mobileCartSummary.textContent = `${items.length} item${items.length !== 1 ? "s" : ""}`;
      mobileCartTotal.textContent = formatCurrency(total);
      syncMobileExpandedContent();
    }

    function syncMobileExpandedContent() {
      orderPanelExpandedBody.innerHTML = orderItemsContainer.innerHTML;
      orderPanelExpandedFooter.innerHTML = orderPanelFooter.innerHTML;
    }

    function expandMobilePanel() {
      mobileExpanded = true;
      orderPanelExpanded.classList.add("active");
      orderPanelOverlay.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function collapseMobilePanel() {
      mobileExpanded = false;
      orderPanelExpanded.classList.remove("active");
      orderPanelOverlay.classList.remove("active");
      document.body.style.overflow = "";
    }

    orderPanelCollapsed.addEventListener("click", () => { if (!mobileExpanded) expandMobilePanel(); });
    orderPanelOverlay.addEventListener("click", collapseMobilePanel);
    document.getElementById("order-panel-expanded-header").addEventListener("click", collapseMobilePanel);

    const origSendMessageNonStreaming = sendMessageNonStreaming;
    sendMessageNonStreaming = async function(text) {
      await origSendMessageNonStreaming(text);
      renderOrderPanel(orderState);
    };

    const origSendMessageStreaming = sendMessageStreaming;
    sendMessageStreaming = async function(text) {
      await origSendMessageStreaming(text);
      renderOrderPanel(orderState);
    };

    renderOrderPanel(orderState);
  </script>
</body>
</html>
