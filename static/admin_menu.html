<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Menu Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/admin_common.css">
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .app-header {
      background: #1976d2;
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .app-header a {
      color: #bbdefb;
      text-decoration: none;
      font-size: 14px;
      margin-left: 16px;
    }
    .layout {
      display: flex;
      height: calc(100vh - 52px);
    }
    .sidebar {
      width: 40%;
      max-width: 520px;
      border-right: 1px solid #ddd;
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #ddd;
    }
    .sidebar-header input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .sidebar-header select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .sidebar-header button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    .sidebar-header button:hover {
      background: #115293;
    }
    .list {
      flex: 1;
      overflow-y: auto;
    }
    .item-row {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .item-row:hover {
      background: #e3f2fd;
    }
    .item-row.active {
      background: #bbdefb;
    }
    .item-main {
      display: flex;
      flex-direction: column;
    }
    .item-name {
      font-weight: 600;
    }
    .item-meta {
      font-size: 12px;
      color: #666;
    }
    .item-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      background: #ffecb3;
      color: #795548;
      margin-left: 6px;
    }
    .empty-state {
      padding: 20px;
      text-align: center;
      color: #777;
      font-size: 14px;
    }
    .detail {
      flex: 1;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    .detail-title {
      font-size: 18px;
      font-weight: 600;
    }
    .detail-nav button {
      padding: 4px 8px;
      margin-left: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .detail-nav button:hover {
      background: #e0e0e0;
    }
    .field-row {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }
    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    .field label {
      margin-bottom: 2px;
      font-weight: 500;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .field input[readonly] {
      background: #e9e9e9;
      color: #666;
      cursor: not-allowed;
    }
    .field textarea {
      min-height: 100px;
      resize: vertical;
      font-family: monospace;
      white-space: pre;
    }
    .field-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 16px;
      font-size: 13px;
    }
    .detail-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .detail-footer .buttons {
      display: flex;
      gap: 8px;
    }
    .detail-footer button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #1976d2;
      color: #fff;
    }
    .btn-primary:hover {
      background: #115293;
    }
    .btn-danger {
      background: #d32f2f;
      color: #fff;
    }
    .btn-danger:hover {
      background: #9a0007;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #000;
    }
    .btn-secondary:hover {
      background: #bdbdbd;
    }
    .status-text {
      font-size: 12px;
      color: #666;
    }
    /* Tab Styles */
    .detail-tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 16px;
    }
    .detail-tab {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: none;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .detail-tab:hover {
      color: #333;
      background: #f5f5f5;
    }
    .detail-tab.active {
      color: #1976d2;
      border-bottom-color: #1976d2;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    /* Attribute Form Styles */
    .attr-form-section {
      margin-bottom: 20px;
    }
    .attr-form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid #eee;
    }
    .attr-form-row:last-child {
      border-bottom: none;
    }
    .attr-form-label {
      font-weight: 500;
      font-size: 13px;
      margin-bottom: 6px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .attr-form-label .required {
      font-size: 10px;
      background: #ffebee;
      color: #c62828;
      padding: 1px 5px;
      border-radius: 4px;
    }
    .attr-form-label .type-badge {
      font-size: 10px;
      background: #e3f2fd;
      color: #1565c0;
      padding: 1px 5px;
      border-radius: 4px;
    }
    .attr-form-control {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .attr-form-control select {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      min-width: 200px;
    }
    .attr-form-control input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      min-width: 200px;
    }
    .attr-checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .attr-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 16px;
      font-size: 12px;
      cursor: pointer;
      background: #fff;
      transition: all 0.15s;
    }
    .attr-chip:hover {
      background: #f5f5f5;
      border-color: #999;
    }
    .attr-chip.selected {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1565c0;
    }
    .attr-chip input[type="checkbox"] {
      display: none;
    }
    .still-ask-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #666;
      margin-left: 12px;
    }
    .still-ask-toggle input {
      width: 14px;
      height: 14px;
    }
    .boolean-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .boolean-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .no-attrs-message {
      padding: 20px;
      text-align: center;
      color: #888;
      font-size: 14px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    /* Toast notification styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      padding: 14px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      max-width: 350px;
    }
    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.info { background: #3b82f6; color: white; }
    .toast-icon { font-size: 18px; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    /* Button state styles */
    .btn-primary.saving, .btn-secondary.saving {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    .btn-primary.saving::after, .btn-secondary.saving::after {
      content: "";
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      display: inline-block;
      vertical-align: middle;
    }
    .btn-primary.saved {
      background: #10b981 !important;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Toast notification container -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="app-header">
    <div>Menu Admin</div>
    <div>
      <a href="/static/index.html">Customer Chat</a>
      <a href="/static/admin_menu.html"><strong>Menu</strong></a>
      <a href="/static/admin_orders.html">Orders</a>
      <a href="/static/admin_ingredients.html">Ingredients</a>
      <a href="/static/admin_modifiers.html">Modifiers</a>
      <a href="/static/admin_global_attributes.html">Global Attrs</a>
      <a href="/static/admin_item_types.html">Item Types</a>
      <a href="/static/admin_modifier_categories.html">Categories</a>
      <a href="/static/admin_modifier_qualifiers.html">Qualifiers</a>
      <a href="/static/admin_stores.html">Stores</a>
      <a href="/static/admin_analytics.html">Analytics</a>
      <a href="/static/admin_company.html">Company</a>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="sidebar-header">
        <input id="searchInput" type="text" placeholder="Search by name or category..." />
        <select id="categoryFilter">
          <option value="">All categories</option>
        </select>
        <button id="newItemBtn">+ New</button>
      </div>
      <div id="menuList" class="list"></div>
    </div>

    <div class="detail">
      <div class="detail-header">
        <div class="detail-title" id="detailTitle">No item selected</div>
        <div class="detail-nav">
          <button id="prevBtn">&larr; Prev</button>
          <button id="nextBtn">Next &rarr;</button>
        </div>
      </div>

      <div id="detailBody" style="flex: 1; overflow-y: auto;">
        <!-- Tabs -->
        <div class="detail-tabs" id="detailTabs">
          <button class="detail-tab active" data-tab="basic">Basic Info</button>
          <button class="detail-tab" data-tab="attributes">Attributes</button>
        </div>

        <!-- Basic Info Tab -->
        <div class="tab-panel active" id="tabBasicInfo">
        <div class="field-row">
          <div class="field">
            <label for="itemId">ID</label>
            <input id="itemId" type="text" readonly />
          </div>
          <div class="field">
            <label for="itemName">Name</label>
            <input id="itemName" type="text" />
          </div>
        </div>

        <div class="field">
          <label for="itemDescription">Description</label>
          <textarea id="itemDescription" rows="2" placeholder="e.g., Two eggs, bacon, and cheddar cheese on a bagel"></textarea>
          <small style="color: #666; font-size: 0.8em;">Brief description of what's included in this item</small>
        </div>

        <div class="field-row">
          <div class="field">
            <label for="itemCategory">Item Type</label>
            <select id="itemCategory">
              <option value="">-- Select Item Type --</option>
            </select>
          </div>
          <div class="field">
            <label for="itemPrice">Base price ($)</label>
            <input id="itemPrice" type="number" step="0.01" />
          </div>
        </div>

        <div class="field-row">
          <div class="field-checkbox">
            <input id="itemSignature" type="checkbox" />
            <label for="itemSignature">Signature item (speed menu)</label>
          </div>
        </div>

        <div class="field">
          <label>Aliases (synonyms for matching)</label>
          <div class="tag-input-container" id="aliasesContainer" onclick="document.getElementById('aliasInput').focus()">
            <input id="aliasInput" class="tag-input" type="text" placeholder="Type and press Enter to add..." />
          </div>
          <small style="color: #666; font-size: 0.8em;">Alternative names that customers might use (press Enter to add each one)</small>
        </div>

        <div class="field">
          <label>Required Match Phrases</label>
          <div class="tag-input-container" id="requiredPhrasesContainer" onclick="document.getElementById('requiredPhraseInput').focus()">
            <input id="requiredPhraseInput" class="tag-input" type="text" placeholder="Type and press Enter to add..." />
          </div>
          <small style="color: #666; font-size: 0.8em;">If set, user input must contain one of these phrases to match this item (prevents "Russian Coffee Cake" from matching just "coffee")</small>
        </div>
        </div><!-- End Basic Info Tab -->

        <!-- Attributes Tab -->
        <div class="tab-panel" id="tabAttributes">
          <div id="attributesContainer">
            <div class="no-attrs-message">Select a menu item to configure its attributes.</div>
          </div>
        </div>
      </div>

      <div class="detail-footer">
        <div class="status-text" id="statusText"></div>
        <div class="buttons">
          <button class="btn-secondary" id="resetBtn">Reset</button>
          <button class="btn-danger" id="deleteBtn">Delete</button>
          <button class="btn-primary" id="saveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/admin_common.js"></script>
  <script>
    const API_BASE = "";
    let allItems = [];
    let filteredItems = [];
    let currentIndex = -1;
    let itemTypes = []; // Store item types for dropdown

    const menuListEl = document.getElementById("menuList");
    const categoryFilterEl = document.getElementById("categoryFilter");
    const searchInputEl = document.getElementById("searchInput");
    const detailTitleEl = document.getElementById("detailTitle");
    const statusTextEl = document.getElementById("statusText");
    const toastContainer = document.getElementById("toastContainer");

    // Toast notification system
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      const icons = { success: "✓", error: "✕", info: "ℹ" };
      toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${message}</span>`;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease forwards";
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Button state management
    function setSaveButtonState(button, state, originalText = "Save") {
      if (!button) return;
      switch (state) {
        case "saving":
          button.disabled = true;
          button.classList.add("saving");
          button.classList.remove("saved");
          button.textContent = "Saving...";
          break;
        case "saved":
          button.disabled = false;
          button.classList.remove("saving");
          button.classList.add("saved");
          button.textContent = "Saved!";
          setTimeout(() => {
            button.classList.remove("saved");
            button.textContent = originalText;
          }, 2000);
          break;
        case "error":
        default:
          button.disabled = false;
          button.classList.remove("saving", "saved");
          button.textContent = originalText;
      }
    }

    const itemIdEl = document.getElementById("itemId");
    const itemNameEl = document.getElementById("itemName");
    const itemDescriptionEl = document.getElementById("itemDescription");
    const itemCategoryEl = document.getElementById("itemCategory");
    const itemPriceEl = document.getElementById("itemPrice");
    const itemSignatureEl = document.getElementById("itemSignature");

    // Tag input elements (functions from admin_common.js)
    const aliasesContainerEl = document.getElementById("aliasesContainer");
    const aliasInputEl = document.getElementById("aliasInput");
    const requiredPhrasesContainerEl = document.getElementById("requiredPhrasesContainer");
    const requiredPhraseInputEl = document.getElementById("requiredPhraseInput");

    setupTagInput(aliasInputEl, aliasesContainerEl);
    setupTagInput(requiredPhraseInputEl, requiredPhrasesContainerEl);

    // Tab elements
    const detailTabsEl = document.getElementById("detailTabs");
    const tabBasicInfoEl = document.getElementById("tabBasicInfo");
    const tabAttributesEl = document.getElementById("tabAttributes");
    const attributesContainerEl = document.getElementById("attributesContainer");
    let currentAttributeFormData = null; // Store loaded attribute form data

    // Tab switching
    detailTabsEl.querySelectorAll(".detail-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const tabName = tab.dataset.tab;
        // Update active tab
        detailTabsEl.querySelectorAll(".detail-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        // Show/hide panels
        tabBasicInfoEl.classList.toggle("active", tabName === "basic");
        tabAttributesEl.classList.toggle("active", tabName === "attributes");
      });
    });

    document.getElementById("newItemBtn").addEventListener("click", () => {
      selectItemByIndex(-1, true);
    });
    document.getElementById("prevBtn").addEventListener("click", () => {
      if (filteredItems.length === 0) return;
      if (currentIndex <= 0) {
        selectItemByIndex(filteredItems.length - 1);
      } else {
        selectItemByIndex(currentIndex - 1);
      }
    });
    document.getElementById("nextBtn").addEventListener("click", () => {
      if (filteredItems.length === 0) return;
      if (currentIndex >= filteredItems.length - 1) {
        selectItemByIndex(0);
      } else {
        selectItemByIndex(currentIndex + 1);
      }
    });
    document.getElementById("saveBtn").addEventListener("click", saveCurrentItem);
    document.getElementById("deleteBtn").addEventListener("click", deleteCurrentItem);
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (currentIndex >= 0) {
        selectItemByIndex(currentIndex);
      } else {
        clearDetailForm();
      }
    });

    searchInputEl.addEventListener("input", applyFilters);
    categoryFilterEl.addEventListener("change", applyFilters);

    // Load item types for the category dropdown
    async function loadItemTypes() {
      try {
        const resp = await fetch(`${API_BASE}/admin/modifiers/item-types`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        itemTypes = await resp.json();

        // Populate the item type dropdown
        itemCategoryEl.innerHTML = '<option value="">-- Select Item Type --</option>';
        itemTypes.forEach(it => {
          const opt = document.createElement("option");
          opt.value = it.id;
          opt.textContent = it.display_name;
          opt.dataset.slug = it.slug;
          itemCategoryEl.appendChild(opt);
        });

        // Also update the category filter in sidebar
        buildCategoryFilterFromItemTypes();
      } catch (err) {
        console.error("Error loading item types:", err);
      }
    }

    function buildCategoryFilterFromItemTypes() {
      categoryFilterEl.innerHTML = '<option value="">All categories</option>';
      itemTypes.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.display_name;
        opt.textContent = it.display_name;
        categoryFilterEl.appendChild(opt);
      });
    }

    function setStatus(msg, isError = false) {
      statusTextEl.textContent = msg || "";
      statusTextEl.style.color = isError ? "#d32f2f" : "#666";
    }

    async function loadMenuItems() {
      setStatus("Loading menu...");
      try {
        const resp = await fetch(`${API_BASE}/admin/menu`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        allItems = data;
        // Category filter is now built from item types in loadItemTypes()
        applyFilters();
        if (filteredItems.length > 0) {
          selectItemByIndex(0);
        } else {
          selectItemByIndex(-1);
        }
        setStatus("Menu loaded.");
      } catch (err) {
        console.error("Error loading menu:", err);
        setStatus("Error loading menu. See console.", true);
      }
    }

    function applyFilters() {
      const query = searchInputEl.value.toLowerCase();
      const cat = categoryFilterEl.value;
      filteredItems = allItems.filter(item => {
        // Find item type for this item
        const itemType = itemTypes.find(it => it.id === item.item_type_id);
        const typeName = itemType ? itemType.display_name : (item.category || "");

        const matchesText =
          !query ||
          (item.name && item.name.toLowerCase().includes(query)) ||
          typeName.toLowerCase().includes(query);
        const matchesCat = !cat || typeName === cat;
        return matchesText && matchesCat;
      });
      renderList();
    }

    function renderList() {
      menuListEl.innerHTML = "";
      if (filteredItems.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "No menu items. Click + New to create one.";
        menuListEl.appendChild(div);
        return;
      }
      filteredItems.forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "item-row" + (idx === currentIndex ? " active" : "");
        row.addEventListener("click", () => selectItemByIndex(idx));

        const main = document.createElement("div");
        main.className = "item-main";
        const name = document.createElement("div");
        name.className = "item-name";
        name.textContent = item.name;
        main.appendChild(name);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        // Find item type name from itemTypes array
        const itemType = itemTypes.find(it => it.id === item.item_type_id);
        const typeName = itemType ? itemType.display_name : (item.category || "uncategorized");
        meta.textContent = `${typeName} • $${item.base_price.toFixed(2)}`;
        main.appendChild(meta);

        row.appendChild(main);

        if (item.is_signature) {
          const badge = document.createElement("span");
          badge.className = "item-badge";
          badge.textContent = "signature";
          row.appendChild(badge);
        }

        menuListEl.appendChild(row);
      });
    }

    function clearDetailForm() {
      detailTitleEl.textContent = "New menu item";
      itemIdEl.value = "";
      itemNameEl.value = "";
      itemDescriptionEl.value = "";
      itemCategoryEl.value = "";
      itemPriceEl.value = "";
      itemSignatureEl.checked = false;
      clearTags(aliasesContainerEl, aliasInputEl);
      clearTags(requiredPhrasesContainerEl, requiredPhraseInputEl);

      // Clear attributes tab
      attributesContainerEl.innerHTML = '<div class="no-attrs-message">Create or select a menu item to configure its attributes.</div>';
      currentAttributeFormData = null;

      // Reset to Basic Info tab
      detailTabsEl.querySelectorAll(".detail-tab").forEach(t => t.classList.remove("active"));
      detailTabsEl.querySelector('[data-tab="basic"]').classList.add("active");
      tabBasicInfoEl.classList.add("active");
      tabAttributesEl.classList.remove("active");
    }

    function selectItemByIndex(idx, newItem = false) {
      currentIndex = idx;
      document.querySelectorAll(".item-row").forEach((row, i) => {
        row.classList.toggle("active", i === currentIndex);
      });

      if (newItem) {
        clearDetailForm();
        return;
      }

      if (currentIndex < 0 || currentIndex >= filteredItems.length) {
        clearDetailForm();
        return;
      }

      const item = filteredItems[currentIndex];
      detailTitleEl.textContent = item.name || "Menu item";
      itemIdEl.value = item.id || "";
      itemNameEl.value = item.name || "";
      itemDescriptionEl.value = item.description || "";
      // Set item type dropdown by item_type_id
      itemCategoryEl.value = item.item_type_id || "";
      itemPriceEl.value = item.base_price != null ? item.base_price : "";
      itemSignatureEl.checked = !!item.is_signature;
      setTags(aliasesContainerEl, aliasInputEl, item.aliases || []);
      setTags(requiredPhrasesContainerEl, requiredPhraseInputEl, item.required_match_phrases || "");

      // Load attributes for the Attributes tab
      loadAttributeForm(item.id);

      // Reset to Basic Info tab when selecting a new item
      detailTabsEl.querySelectorAll(".detail-tab").forEach(t => t.classList.remove("active"));
      detailTabsEl.querySelector('[data-tab="basic"]').classList.add("active");
      tabBasicInfoEl.classList.add("active");
      tabAttributesEl.classList.remove("active");
    }

    async function saveCurrentItem() {
      const saveBtn = document.getElementById("saveBtn");
      const id = itemIdEl.value ? parseInt(itemIdEl.value, 10) : null;
      const selectedItemTypeId = itemCategoryEl.value ? parseInt(itemCategoryEl.value, 10) : null;
      // Get the display_name from the selected option for category field
      const selectedOption = itemCategoryEl.options[itemCategoryEl.selectedIndex];
      const categoryName = selectedOption && selectedOption.value ? selectedOption.textContent : "";

      // Get tag values as comma-separated strings for API
      const aliasValues = getTagValues(aliasesContainerEl);
      const requiredPhraseValues = getTagValues(requiredPhrasesContainerEl);

      const payload = {
        name: itemNameEl.value.trim(),
        description: itemDescriptionEl.value.trim() || null,
        category: categoryName, // Keep category as display name for backwards compatibility
        item_type_id: selectedItemTypeId,
        is_signature: itemSignatureEl.checked,
        base_price: parseFloat(itemPriceEl.value || "0"),
        aliases: aliasValues.length > 0 ? aliasValues.join(",") : null,
        required_match_phrases: requiredPhraseValues.length > 0 ? requiredPhraseValues.join(",") : null
      };

      if (!payload.name) {
        setStatus("Name is required.", true);
        showToast("Name is required.", "error");
        return;
      }

      const method = id ? "PUT" : "POST";
      const url = id ? `${API_BASE}/admin/menu/${id}` : `${API_BASE}/admin/menu`;

      setSaveButtonState(saveBtn, "saving");
      setStatus("Saving item...");
      try {
        const resp = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          credentials: 'include'
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const saved = await resp.json();
        setSaveButtonState(saveBtn, "saved", "Save");
        showToast("Menu item saved successfully!", "success");
        setStatus("Saved.");
        await loadMenuItems();
        const idx = filteredItems.findIndex(i => i.id === saved.id);
        if (idx !== -1) {
          selectItemByIndex(idx);
        }
      } catch (err) {
        console.error("Error saving item:", err);
        setSaveButtonState(saveBtn, "error", "Save");
        showToast("Error saving item. See console.", "error");
        setStatus("Error saving item. See console.", true);
      }
    }

    async function deleteCurrentItem() {
      const id = itemIdEl.value ? parseInt(itemIdEl.value, 10) : null;
      if (!id) {
        setStatus("Nothing to delete.", true);
        return;
      }
      if (!confirm("Delete this menu item?")) return;

      setStatus("Deleting item...");
      try {
        const resp = await fetch(`${API_BASE}/admin/menu/${id}`, {
          method: "DELETE",
          credentials: 'include'
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        await loadMenuItems();
        selectItemByIndex(0);
        setStatus("Item deleted.");
      } catch (err) {
        console.error("Error deleting item:", err);
        setStatus("Error deleting item. See console.", true);
      }
    }

    // ==================== Attribute Tab Functions ====================

    async function loadAttributeForm(itemId) {
      if (!itemId) {
        attributesContainerEl.innerHTML = '<div class="no-attrs-message">Select a menu item to configure its attributes.</div>';
        currentAttributeFormData = null;
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/admin/menu/${itemId}/edit-form`, { credentials: 'include' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        currentAttributeFormData = data;
        renderAttributeForm(data);
      } catch (err) {
        console.error("Error loading attribute form:", err);
        attributesContainerEl.innerHTML = '<div class="no-attrs-message">Error loading attributes. See console.</div>';
        currentAttributeFormData = null;
      }
    }

    function renderAttributeForm(data) {
      if (!data.fields || data.fields.length === 0) {
        attributesContainerEl.innerHTML = '<div class="no-attrs-message">This item type has no configurable attributes.</div>';
        return;
      }

      let html = '<div class="attr-form-section">';

      for (const field of data.fields) {
        html += `<div class="attr-form-row" data-attr-id="${field.attribute_id}" data-attr-slug="${field.slug}">`;
        html += `<div class="attr-form-label">`;
        html += `<span>${field.display_name}</span>`;
        if (field.is_required) {
          html += `<span class="required">Required</span>`;
        }
        html += `<span class="type-badge">${field.input_type}</span>`;
        html += `</div>`;
        html += `<div class="attr-form-control">`;

        if (field.input_type === 'single_select') {
          html += renderSingleSelect(field);
        } else if (field.input_type === 'multi_select') {
          html += renderMultiSelect(field);
        } else if (field.input_type === 'boolean') {
          html += renderBooleanToggle(field);
        } else if (field.input_type === 'text') {
          html += renderTextInput(field);
        }

        // Still ask toggle (for single_select and boolean)
        if (field.input_type === 'single_select' || field.input_type === 'boolean') {
          const stillAskChecked = field.still_ask ? 'checked' : '';
          html += `<label class="still-ask-toggle">`;
          html += `<input type="checkbox" class="still-ask-checkbox" data-attr-id="${field.attribute_id}" ${stillAskChecked}>`;
          html += `<span>Still ask customer</span>`;
          html += `</label>`;
        }

        html += `</div></div>`;
      }

      html += '</div>';
      html += '<div style="margin-top: 16px; display: flex; justify-content: flex-end;">';
      html += '<button class="btn-primary" id="saveAttributesBtn">Save Attributes</button>';
      html += '</div>';

      attributesContainerEl.innerHTML = html;

      // Add save button listener
      document.getElementById("saveAttributesBtn").addEventListener("click", saveAttributes);

      // Add change listeners to update UI feedback
      attributesContainerEl.querySelectorAll("select, input").forEach(el => {
        el.addEventListener("change", () => {
          // Mark form as dirty if needed
        });
      });

      // Add chip click listeners for multi-select
      attributesContainerEl.querySelectorAll(".attr-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const checkbox = chip.querySelector("input[type='checkbox']");
          checkbox.checked = !checkbox.checked;
          chip.classList.toggle("selected", checkbox.checked);
        });
      });
    }

    function renderSingleSelect(field) {
      let html = `<select data-attr-id="${field.attribute_id}" class="attr-select">`;
      if (field.allow_none) {
        html += `<option value="">-- None --</option>`;
      }
      for (const opt of field.options) {
        const selected = field.current_option_id === opt.id ? 'selected' : '';
        const price = opt.price_modifier > 0 ? ` (+$${opt.price_modifier.toFixed(2)})` : '';
        html += `<option value="${opt.id}" ${selected}>${opt.display_name}${price}</option>`;
      }
      html += `</select>`;
      return html;
    }

    function renderMultiSelect(field) {
      let html = '<div class="attr-checkbox-group">';
      const selectedIds = field.current_option_ids || [];
      for (const opt of field.options) {
        const isSelected = selectedIds.includes(opt.id);
        const selectedClass = isSelected ? 'selected' : '';
        const checked = isSelected ? 'checked' : '';
        const price = opt.price_modifier > 0 ? ` (+$${opt.price_modifier.toFixed(2)})` : '';
        html += `<label class="attr-chip ${selectedClass}">`;
        html += `<input type="checkbox" value="${opt.id}" data-attr-id="${field.attribute_id}" ${checked}>`;
        html += `${opt.display_name}${price}`;
        html += `</label>`;
      }
      html += '</div>';
      return html;
    }

    function renderBooleanToggle(field) {
      const checked = field.current_boolean === true ? 'checked' : '';
      return `<label class="boolean-toggle">
        <input type="checkbox" data-attr-id="${field.attribute_id}" class="attr-boolean" ${checked}>
        <span>${field.current_boolean === true ? 'Yes' : 'No'}</span>
      </label>`;
    }

    function renderTextInput(field) {
      const value = field.current_text || '';
      return `<input type="text" data-attr-id="${field.attribute_id}" class="attr-text" value="${value}" placeholder="Enter value...">`;
    }

    async function saveAttributes() {
      const saveAttrBtn = document.getElementById("saveAttributesBtn");
      const itemId = itemIdEl.value ? parseInt(itemIdEl.value, 10) : null;
      if (!itemId || !currentAttributeFormData) {
        setStatus("No item selected.", true);
        showToast("No item selected.", "error");
        return;
      }

      // Build the attributes payload
      const attributes = {};

      for (const field of currentAttributeFormData.fields) {
        const attrId = field.attribute_id;
        const slug = field.slug;

        if (field.input_type === 'single_select') {
          const selectEl = attributesContainerEl.querySelector(`select[data-attr-id="${attrId}"]`);
          const stillAskEl = attributesContainerEl.querySelector(`.still-ask-checkbox[data-attr-id="${attrId}"]`);
          if (selectEl) {
            const optionId = selectEl.value ? parseInt(selectEl.value, 10) : null;
            attributes[slug] = {
              option_id: optionId,
              still_ask: stillAskEl ? stillAskEl.checked : false
            };
          }
        } else if (field.input_type === 'multi_select') {
          const checkboxes = attributesContainerEl.querySelectorAll(`input[type="checkbox"][data-attr-id="${attrId}"]:not(.still-ask-checkbox)`);
          const selectedIds = [];
          checkboxes.forEach(cb => {
            if (cb.checked) {
              selectedIds.push(parseInt(cb.value, 10));
            }
          });
          attributes[slug] = {
            selected_option_ids: selectedIds
          };
        } else if (field.input_type === 'boolean') {
          const boolEl = attributesContainerEl.querySelector(`input.attr-boolean[data-attr-id="${attrId}"]`);
          const stillAskEl = attributesContainerEl.querySelector(`.still-ask-checkbox[data-attr-id="${attrId}"]`);
          if (boolEl) {
            attributes[slug] = {
              value_boolean: boolEl.checked,
              still_ask: stillAskEl ? stillAskEl.checked : false
            };
          }
        } else if (field.input_type === 'text') {
          const textEl = attributesContainerEl.querySelector(`input.attr-text[data-attr-id="${attrId}"]`);
          if (textEl) {
            attributes[slug] = {
              value_text: textEl.value || null
            };
          }
        }
      }

      const payload = { attributes };

      setSaveButtonState(saveAttrBtn, "saving");
      setStatus("Saving attributes...");
      try {
        const resp = await fetch(`${API_BASE}/admin/menu/${itemId}/attributes`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          credentials: 'include'
        });
        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({}));
          throw new Error(errData.detail || `HTTP ${resp.status}`);
        }
        setSaveButtonState(saveAttrBtn, "saved", "Save Attributes");
        showToast("Attributes saved successfully!", "success");
        setStatus("Attributes saved.");
        // Reload attribute form to show updated state
        await loadAttributeForm(itemId);
      } catch (err) {
        console.error("Error saving attributes:", err);
        setSaveButtonState(saveAttrBtn, "error", "Save Attributes");
        showToast("Error saving attributes: " + err.message, "error");
        setStatus("Error saving attributes: " + err.message, true);
      }
    }

    // ==================== End Attribute Tab Functions ====================

    // Initialize: load item types first, then menu items
    async function init() {
      await loadItemTypes();
      await loadMenuItems();
    }
    init();
  </script>
</body>
</html>
